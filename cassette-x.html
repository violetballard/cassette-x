<!doctype html> <html><meta charset=utf-8><head> <title>Cassette X</title> <tw-storydata name="Cassette X" startnode="2" creator="Twine" creator-version="2.8.1" format="AdventureTome" format-version="0.2.1" ifid="0AFD72B7-FF30-4C86-88FB-F5C1AA8C706D" options="" tags="" zoom="0.6" hidden><style role="stylesheet" id="twine-user-stylesheet" type="text/twine-css"></style><script role="script" id="twine-user-script" type="text/twine-javascript"></script><tw-tag name="chapter_1" color="purple"></tw-tag><tw-tag name="chapter_3" color="green"></tw-tag><tw-tag name="chapter_4" color="yellow"></tw-tag><tw-tag name="end" color="red"></tw-tag><tw-tag name="chapter_start" color="yellow"></tw-tag><tw-tag name="chapter_0" color="yellow"></tw-tag><tw-tag name="chapter_2" color="blue"></tw-tag><tw-tag name="ending" color="red"></tw-tag><tw-tag name="chapter_end" color="yellow"></tw-tag><tw-passagedata pid="1" name="Rules" tags="backmatter menulinked" position="400,600" size="100,100">&lt;b&gt;How do you play?&lt;/b&gt;
Read the story and make decisions. Move to the numbered passage indicated when you must decide where to go.

&lt;b&gt;What do you need?&lt;/b&gt;
- 1d100
- 2d10
- 1d5 (Optional)
-- When asked to roll 1d5, you can roll 1d10 and subtract 5 from the result if it is greater than 5.
-- You can also roll 1d6 and re-roll on a result of 6.

&lt;b&gt;Health and Stress&lt;/b&gt;
You start with 10 Health. You may be instructed by the text to take or heal damage. If your Health is reduced to 0, you die and must restart the adventure. Track this using a d10.

You start with 0 Stress. You may be instructed by the text to gain or relieve Stress. Once you reach 10 Stress, any subsequent Stress deals damage instead. Track this using a d10.

You may heal Damage or relieve Stress at anytime using a Medkit (Heal 1d5 Damage) or Anti-Anxiety Drugs (Relieve 1d5 Stress).

&lt;b&gt;Checks and Saves&lt;/b&gt;
If the results of an action are uncertain, the text will ask you to make a Check if you are taking an action or a Save if you are reacting to something.

To successfully make a Check or Save, you must roll 1d100 with the value less than or equal to the specified Stat. If you fail, you gain 1 Stress.

&lt;b&gt;Advantage&lt;/b&gt;
If a Check or Save lists an applicable Background or one of your items could assist you with your task, you gain Advantage. When you have Advantage, roll the 1d100 twice and use the lower number to evaluate your success. Critical Successes and Critical Failures always override any other roll with a Critical Success always taking precedent followed by a Critical Failure.

&lt;b&gt;Critical Successes or Failures&lt;/b&gt;
When making a Check or Save if you roll a number consisting of doubles (00, 11, 22, etc), then you have a rolled a Critical Success or Failure.

Upon a Critical Success, you relieve 1 Stress. Upon a Critical Failure, you Panic in addition to gaining 1 Stress for failing the Check or Save.

&lt;b&gt;Push Your Luck&lt;/b&gt;
You may gain 1 Stress to re-roll, this includes Panic Checks.

&lt;b&gt;Panic&lt;/b&gt;
You may Panic due to a Critical Failure or because the text asks you to make a Panic Check. When you Panic, you roll a d10, and if it is less than or equal to your current Stress Level, you Panic and suffer the corresponding consequence listed on the Panic Table.</tw-passagedata><tw-passagedata pid="2" name="Scenario" tags="" position="500,500" size="100,100">&lt;h1&gt;The Arrival of Cassette X&lt;/h1&gt;
A mysterious tape, Cassette X, has been delivered to the Hecate Cassette Archive by corpo-fascist spy Benjamin Dryden. Dryden represents the shadowy Neo-Reactionary Coalition amongst many corporate interests, infecting their organizations with fascist beliefs.

You are Hector Finley, a mere technician, tasked with cataloging and then securely archiving Cassette X, so it can live forever in a sterile coffin.

[[Examine Cassette X-&gt;s1-examination]].</tw-passagedata><tw-passagedata pid="3" name="s1-examination" tags="chapter_1 chapter_start" position="700,500" size="100,100">Lockdog brings a sealed bag to your lab with Cassette X inside: &quot;This is an odd one, Hector. Please call your lead archivist if you notice anything strange. The suits have taken notice of this one, don&#39;t fuck it up!&quot;

Make a Fear Save.

Pure Transmission Protocol requires an inspection by an archival technician before it is placed in the archive. You need to perform a visual, microscopic, and chemical examination of the tape to determine the best methods for preservation. You then need to document this information on a punch card and have Lockdog bring the cassette and card to the next technician for archival preparation.

You feel a mystic draw to the tape, an intangible feeling that it means something for your Void Musician heritage.

Make a Sanity Save [Religious Background].

[[Perform a visual examination of Cassette X-&gt;s1-visualexam]].

Download the data from the tape. Make an Intellect Check [Computer Background].
[[On Success-&gt;s1-downloads]]
[[On Failure-&gt;s1-downloadf]]

[[Place Cassette X in the chemical scanner-&gt;s1-scanner]].

[[Call your lead archivist-&gt;s1-phonecall]].</tw-passagedata><tw-passagedata pid="4" name="Character Sheet" tags="charactersheet" position="400,400" size="100,100">$$check_die_1$$ $$check_die_2$$
*Check Dice - d100*

$$dmg_die$$
*Damage and Stress Die - d5*

&lt;b&gt;Hector Finley&lt;/b&gt;
You are a mere technician, tasked with cataloging and then securely archiving Cassette X, so it can live&lt;br&gt;forever in a sterile coffin.

&lt;b&gt;Backgrounds&lt;/b&gt;
Academic, Computer, Mechanical, Religious

&lt;b&gt;Checks&lt;/b&gt;
$$combat$$ $$strength$$ $$speed$$ $$intellect$$

&lt;b&gt;Saves&lt;/b&gt;
$$fear$$ $$body$$ $$sanity$$

&lt;b&gt;Health&lt;/b&gt;
*Dead at 0 Health*
$$current_health$$ $$max_health$$
&lt;button onclick=&quot;subtractHealth()&quot;&gt;-&lt;/button&gt; &lt;button onclick=&quot;addHealth()&quot;&gt;+&lt;/button&gt;

&lt;b&gt;Stress&lt;/b&gt;
*Lose Health if you gain Stress beyond your max*
$$current_stress$$ $$max_stress$$
&lt;button onclick=&quot;subtractStress()&quot;&gt;-&lt;/button&gt; &lt;button onclick=&quot;addStress()&quot;&gt;+&lt;/button&gt;

&lt;b&gt;Inventory&lt;/b&gt;
$$inventory$$

&lt;b&gt;Loadout&lt;/b&gt;
Clean Room Suit, Soldering Iron, Lead Solder, &lt;br&gt;Magnetic Screwdriver, Scalpel, Tweezers,&lt;br&gt;Electrical Tape, Head Lamp w/ Magnifier,&lt;br&gt;Security Keycard

&lt;b&gt;Panic&lt;/b&gt;
$$panic_die$$
*Panic Die - d10*
&lt;ol&gt;
&lt;li&gt;CHUCKLE: Relieve 1 Stress&lt;/li&gt;
&lt;li&gt;SKIN PICKING: Take 1 Damage&lt;/li&gt;
&lt;li&gt;SEE THE DEAD: Gain 1 Stress&lt;/li&gt;
&lt;li&gt;BAD VIBES: Remove a random consumable item from your Inventory&lt;/li&gt;
&lt;li&gt;HALLUCINATION: On your next Check or Save reverse the results of the rolls (39 becomes 93)&lt;/li&gt;
&lt;li&gt;FOCUS: Re-roll the Panic Check&lt;/li&gt;
&lt;li&gt;THE YIPS: Lose a random background&lt;/li&gt;
&lt;li&gt;TOUCHED THE VOID: Gain 1d5 Stress&lt;/li&gt;
&lt;li&gt;POSSESSED: Turn to a random passge&lt;/li&gt;
&lt;li&gt;HEART ATTACK: Dead&lt;/li&gt;
&lt;/ol&gt;

&lt;csitems&gt;

&lt;die name=&quot;check_die_1&quot; dietype=&quot;d100&quot; value=&quot;99&quot; alt=&quot;Die for Checks and Saves&quot; label=&quot;d100&quot;&gt;

&lt;die name=&quot;check_die_2&quot; dietype=&quot;d100&quot; value=&quot;99&quot; alt=&quot;Die for Checks and Saves&quot; label=&quot;d100&quot;&gt;

&lt;die name=&quot;dmg_die&quot; dietype=&quot;d5&quot; value=&quot;5&quot; alt=&quot;Die for Damage and Stress&quot; label=&quot;d5&quot;&gt;

&lt;number name=&quot;current_health&quot; value=&quot;10&quot; alt=&quot;Current Health&quot; label=&quot;Current HP&quot;&gt;

&lt;number name=&quot;max_health&quot; value=&quot;10&quot; alt=&quot;Maximum Health&quot; label=&quot;Max HP&quot;&gt;

&lt;number name=&quot;current_stress&quot; value=&quot;0&quot; alt=&quot;Current Stress&quot; label=&quot;Current Stress&quot;&gt;

&lt;number name=&quot;max_stress&quot; value=&quot;10&quot; alt=&quot;Maximum Stress&quot; label=&quot;Max Stress&quot;&gt;

&lt;text array values=&quot;1 Medkit (+1d5 HP)|1 Anti-Anxiety Pill (-1d5 Stress)&quot; name=&quot;inventory&quot;&gt;

&lt;die name=&quot;panic_die&quot; dietype=&quot;d10&quot; value=&quot;1&quot; alt=&quot;Panic Die&quot; label=&quot;d10&quot;&gt;

&lt;uneditable name=&quot;combat&quot; value=&quot;35&quot; alt=&quot;Combat Stat&quot; label=&quot;Combat&quot;&gt;

&lt;uneditable name=&quot;strength&quot; value=&quot;40&quot; alt=&quot;Strength Stat&quot; label=&quot;Strength&quot;&gt;

&lt;uneditable name=&quot;speed&quot; value=&quot;45&quot; alt=&quot;Speed Stat&quot; label=&quot;Speed&quot;&gt;

&lt;uneditable name=&quot;intellect&quot; value=&quot;70&quot; alt=&quot;Intellect Stat&quot; label=&quot;Intellect&quot;&gt;

&lt;uneditable name=&quot;fear&quot; value=&quot;50&quot; alt=&quot;Fear Stat&quot; label=&quot;Fear&quot;&gt;

&lt;uneditable name=&quot;body&quot; value=&quot;30&quot; alt=&quot;Body Stat&quot; label=&quot;Body&quot;&gt;

&lt;uneditable name=&quot;sanity&quot; value=&quot;60&quot; alt=&quot;Sanity Stat&quot; label=&quot;Sanity&quot;&gt;

&lt;/csitems&gt;

&lt;script&gt;

function addHealth() {
	let current = csGet(&quot;current_health&quot;);
    let max = csGet(&quot;max_health&quot;);
    if (current &lt; max) {
    	csAdd(&quot;current_health&quot;, 1);
    }
}

function subtractHealth() {
	let current = csGet(&quot;current_health&quot;);
    if(current &gt; 0) {
    	csSubtract(&quot;current_health&quot;, 1);
    }
}

function addStress() {
	let current = csGet(&quot;current_stress&quot;);
    let max = csGet(&quot;max_stress&quot;);
    let health = csGet(&quot;current_health&quot;);
    if (current &lt; max) {
    	csAdd(&quot;current_stress&quot;, 1);
    } else if (health &gt; 0) {
    	csSubtract(&quot;current_health&quot;, 1);
    }
}

function subtractStress() {
	let current = csGet(&quot;current_stress&quot;);
    if(current &gt; 0) {
    	csSubtract(&quot;current_stress&quot;, 1);
    }
}

&lt;/script&gt;</tw-passagedata><tw-passagedata pid="5" name="s1-visualexam" tags="chapter_1" position="900,600" size="100,100">You open the case, remove the cassette and place it on your workbench. You turn it over in your hands, and it appears to have specks of a substance that resembles blood stuck to the outside of the cassette. The tape is labeled in ballpoint pen with the title &quot;Cassette X.&quot;

You peer closer at the tape using your headlamp, looking for any distinctive features, and you start to feel strange. Your vision goes black, and you&#39;re in an infinite void. After an indefinite amount of time, your consciousness comes back to the lab. Your hands are shaking, and you feel the air vibrate with an inaudible hum.

Gain 1d5 Stress.
Make a Sanity Save [Religious Background].
Make a Panic Check.

[[Continue to process Cassette X for archiving-&gt;s1-examination]].

[[Call your lead archivist-&gt;s1-phonecall]].</tw-passagedata><tw-passagedata pid="6" name="s1-downloadf" tags="chapter_1" position="900,50" size="100,100">All of the lights in the room rhythmically flicker on and off. Devices whir and beep and flash nonsense error codes.

Make a Fear Save.

The doors lock and unlock until suddenly the lights come back on and all screens and devices appear as normal.

Make a Sanity Save.
Manic a Panic Check.

[[Try Again-&gt;s1-downloads]].

[[Perform further examination-&gt;s1-examination]].

[[Call your lead archivist-&gt;s1-phonecall]]. </tw-passagedata><tw-passagedata pid="7" name="s1-scanner" tags="chapter_1" position="900,725" size="100,100">A bright flash of light fills the room, and there is a smell of ozone.

Make a Body Save, take 1d5 damage on failure.
Make a Panic Check.

You attempt to remove the tape from the scanner.

Make a Speed Check [Mechanical Background]. You always succeed in removing the tape.
On Success, you remove the tape with no negative consequences.
On Failure, you must make a Body Save to avoid another 1d5 damage.

[[Continue the examination-&gt;s1-examination]].

[[Call your lead archivist-&gt;s1-phonecall]].</tw-passagedata><tw-passagedata pid="8" name="s1-phonecall" tags="chapter_1 chapter_end" position="1100,500" size="100,100">You pick up your secure line to speak to someone. Your supervisor has always been a bit of a corpo stooge, so you skip over him to talk directly to Rosmerta. She knows that if she gets a call from you in the lab that it is something of the utmost importance.

Rosmerta asks you what&#39;s going on, and you report on the results from your Examination of Cassette X. She asks Lockdog what he thinks.

Lockdog: &quot;That shit is cursed! It needs to die in a fire!&quot;

Rosmerta asks you to destroy the tape with Lockdog as your chaperone. She asks you to keep it quiet because corporate does not need to get wind of this. She&#39;ll make sure that it looks like a mistake if anyone checks the records.

[[Go to the tape destruction room-&gt;s2-destruction]].</tw-passagedata><tw-passagedata pid="9" name="s1-downloads" tags="chapter_1" position="900,200" size="100,100">The waveform for the Cassette X  pops up on your terminal screen. There appears to be some dialog, a song, random noise, and then a waveform that fills all measurable frequencies of sound.

[[Listen to the tape-&gt;s1-downloads-play]].

[[Perform further examination-&gt;s1-examination]].

[[Call your lead archivist-&gt;s1-phonecall]]. </tw-passagedata><tw-passagedata pid="10" name="s3-isolation" tags="chapter_3 chapter_start" position="2000,500" size="100,100">You approach the isolation room and the entrance to the area is already open: suspicious. You head down the stairs to the isolation room itself, and there is a Void Musician outside the room standing guard with a circle of cloaked Void Musicians chanting around the table in the center of the room, staring intently at a tape player in the middle of the table.

You ask the Void Musicians what they are doing there, breaking their concentration.
Their leader responds: &quot;We are here for a sacred tape. Is that it in your hands?&quot;

Attempt to convince the leader to leave without the tape. Make an Intellect Check [Religious Background].
[[On Success-&gt;s3-discussions]]
[[On Failure-&gt;s3-discussionf]]

Attempt to stab the leader with your scalpel. Make a Combat Check [Scalpel].
[[On Success-&gt;s3-stabs]]
[[On Failure-&gt;s3-stabf]]

&quot;I respect our religion even though I have left the clergy. Here is the tape, please be careful with it. It holds great power.&quot;
[[Give the leader Cassette X-&gt;s3-peace]].</tw-passagedata><tw-passagedata pid="11" name="s3-violence" tags="chapter_3" position="2400,500" size="100,100">You slam the door to the isolation room shut. Lockdog inserts his probe into the door interface, locking it from the outside. You know there is not an inside access. You throw yourself across the table to try and stop the Void Musicians from playing Cassette X. They throw you against the back wall, and they press play on the tape deck on the table in the center of the room.

[[Turnto-&gt;The End]].</tw-passagedata><tw-passagedata pid="12" name="s2-destruction" tags="chapter_2 chapter_start" position="1300,500" size="100,100">You enter the tape destruction room with Lockdog. You have a variety of ways to try and destroy Cassette X.

[[Crush the tape-&gt;s2-crusher]].

[[Dissolve the tape-&gt;s2-acid]].

[[Burn the tape-&gt;s2-fire]].

[[Call Rosmerta-&gt;s2-dryden]].</tw-passagedata><tw-passagedata pid="13" name="s2-crusher" tags="chapter_2" position="1500,250" size="100,100">You place Cassette X on the bed of a hydraulic press. You watch the press come down and it gets stuck one foot from Cassette X. You hear burbling and start to see hot hydraulic fluid escape the top of the press. A bolt shears off and shoots towards your body.

Make a Body Save or take 1d5 damage.
Make a Panic Check.

You hit the emergency shut off button and the machine goes into standby with the press still in mid-air. You grab the tape from the press.

[[Attempt another method of destruction-&gt;s2-destruction]].

[[Call Rosmerta-&gt;s2-dryden]].</tw-passagedata><tw-passagedata pid="14" name="s2-acid" tags="chapter_2" position="1500,375" size="100,100">You drop the tape into a tub of acid. It boils and splashes all over the room like the tape is itself a strong base chemical. Your clean room suit provides some protection since you didn&#39;t bother to remove it when you left the lab. The tape is somehow unharmed.

Make a Body Save or take 1 Damage.
Make a Panic Check.

[[Attempt another method of destruction-&gt;s2-destruction]].

[[Call Rosmerta-&gt;s2-dryden]].</tw-passagedata><tw-passagedata pid="15" name="s2-fire" tags="chapter_2" position="1500,625" size="100,100">You need to attempt to override the maximum temperature valve.

Make an Intellect Check before feeding Cassette X into the incinerator [Mechanical Background].
[[On Success-&gt;s2-fires]]
[[On Failure-&gt;s2-firef]]</tw-passagedata><tw-passagedata pid="16" name="s2-dryden" tags="chapter_2" position="1700,500" size="100,100">You move into the office in the tape destruction room to find a secure phone only to see Benjamin Dryden already there holding a pistol aimed at your head, his eyes are completely black. Lockdog points their shotgun at Dryden with their laser sight in the middle of his forehead. A security guard walks in for his regular patrol.

Lockdog: &quot;We are on classified duty and this man is an intruder.&quot;

Dryden drops his gun, grabs the security guard, latches his mouth over the security guards own, and lets out a guttural growl. The guardâ€™s eyes turn black, and Dryden collapses to the floor while the security guard flees the room.

[[Call Rosmerta-&gt;s2-phonecall]].</tw-passagedata><tw-passagedata pid="17" name="s2-phonecall" tags="chapter_2 chapter_end" position="1825,500" size="100,100">You&#39;re finally able to call Rosmerta. You let her know what has happened with Dryden and the security guard.

Lockdog: &quot;Shit&#39;s fucked! It&#39;s gone totally pear shaped!&quot;

Rosmerta directs you to take the tape to the isolation room for permanent storage since there are no other options for an anomaly like Cassette X.

[[Take the tape to the isolation room-&gt;s3-isolation]]. </tw-passagedata><tw-passagedata pid="18" name="s2-fires" tags="chapter_2" position="1500,500" size="100,100">You watch through the incinerator window as the tape bubbles, crackles, and turns to ash. You turn off the incinerator, and you see the tape turn into a puddle of goo that reforms into Cassette X.

Make a Sanity Save.
Make a Panic Check.

[[Attempt another method of destruction-&gt;s2-destruction]].

[[Call Rosmerta-&gt;s2-dryden]].</tw-passagedata><tw-passagedata pid="19" name="s2-firef" tags="chapter_2" position="1500,750" size="100,100">You watch through the incinerator window as the tape goes unharmed. You swear that you can hear it laugh.

Make a Fear Save.
Make a Panic Check.

[[Attempt another method of destruction-&gt;s2-destruction]].

[[Call Rosmerta-&gt;s2-dryden]].</tw-passagedata><tw-passagedata pid="20" name="s3-discussions" tags="chapter_3" position="2200,725" size="100,100">The Void Musician leader discusses the dangers of the tape with you. He agrees to let you keep it safe because it has such mystical significance.

Another Void Musician doesn&#39;t like this: &quot;I must hear the music of the spheres!&quot; She kicks the leader in the groin, sending him to the ground, and she bites your hand (Take 1 Damage) until you let go of the tape. She grabs it and moves towards the table and the tape deck.

[[Isolate Cassette X-&gt;s3-violence]].</tw-passagedata><tw-passagedata pid="21" name="s3-discussionf" tags="chapter_3" position="2200,600" size="100,100">The Void Musician leader laughs: &quot;We&#39;re gonna get that tape, and your little dog too!&quot;

He slaps you in the face so hard that you drop Cassette X to the floor in front of him with blood dripping from your nose. He picks up the tape and brings it to the table and the cassette player.

[[Isolate Cassette X-&gt;s3-violence]].</tw-passagedata><tw-passagedata pid="22" name="s3-stabs" tags="chapter_3" position="2200,275" size="100,100">Your scalpel enters the neck of the Void Musician leader and a spray of bright red blood hits you in the face. It tastes like pennies. You feel a fist hit your face and as you&#39;re spitting teeth (Take 1d5 Damage), Cassette X falls from your hands to the floor. The crowd of Void Musicians swarm around the tape, pick it up, and bring it towards the table and the tape player.

[[Isolate Cassette X-&gt;s3-violence]].</tw-passagedata><tw-passagedata pid="23" name="s3-stabf" tags="chapter_3" position="2200,400" size="100,100">The Void Musician leader swings their cloak, deflecting your scalpel. He laughs and grabs your wrist hard until you drop Cassette X. He gestures his head towards another Void Musician who picks up the tape and brings it towards the table and the tape deck.

[[Isolate Cassette X-&gt;s3-violence]].</tw-passagedata><tw-passagedata pid="24" name="s1-downloads-play" tags="chapter_1" position="900,350" size="100,100">You put on headphones, and you press play and listen to Cassette X: &quot;This is the first test of a new upgraded transmitter for my homebrew radio telescope. I should really get some range on this one. I&#39;m now going to point it at the anomaly that I found with my earlier version.&quot;

The song plays, you hear a strange soundscape, and then you feel a terrible pain in your ears and a swelling in your head.

Take 1d5 Stress.
Take 1d5 Damage.

You feel a convulsion through your body, and a cloud of black smoke exists your body and is sucked into the air filtration system. You then vomit yellow bile into your trash can and wipe your face.

Make a Sanity Save.
Make a Panic Check.

[[Perform further examination-&gt;s1-examination]].

[[Call your lead archivist-&gt;s1-phonecall]].</tw-passagedata><tw-passagedata pid="25" name="The End" tags="chapter_3 chapter_end ending" position="2600,500" size="100,100">A ghost oozes out of the speaker, and it enters into the mouth of a Void Musician. They let out an impenetrable howl, and the ghost exits while they slump to the floor. The ghost passes through every Void Musician in turn, and it approaches you.

The last thing you see before everything goes dark is Lockdog staring into your eyes through the safety glass with the Void Musician guard standing next to him.</tw-passagedata><tw-passagedata pid="26" name="s3-peace" tags="chapter_3" position="2200,125" size="100,100">The Void Musician leader places the tape on the table and starts a prayer, the rest of the Void Musicians form a circle and join hands. You join the circle.

The tape deck springs open and the tape starts to vibrate. The clamshell tape clatters open. The prayer swells and the tape begins to levitate, making its way inside the player. The deck closes, the rewind button depresses, and the tape is sent back to the beginning at high speed.

Lockdog sees this and inserts his probe into the door interface, locking it from the outside.

The play button locks, and they all have a moment of prayer to a beautiful song

[[Turnto-&gt;The End]].
</tw-passagedata></tw-storydata> <adventuretomestyle hidden> :root{--textCol:#444;--linkCol:#222;--pageCol:#eee;--buttonCol:#f0f0f0;--panelCol:#e1e1e1;--panelBorderCol:#000;--panelElementA:#e9e9e9;--panelElementB:#e0e0e0;--panelElementActive:#f7fff7;--panelElementHover:#fff;--labelCol:#777;--csitemBorder:#555;--uiGraphics:rgb(0,0,0,0.2);--bookmarkCol:#dd1010;--buttonDisabledCol:#999;--diceFill:white;--diceStroke:black;--imgopacity:1}body.dark-theme{--textCol:#aaa;--linkCol:#ddd;--pageCol:#000;--panelCol:#1e1e1e;--buttonCol:#222;--panelBorderCol:#999;--panelElementA:#2f2f2f;--panelElementB:#2a2a2a;--panelElementActive:#6f666f;--panelElementHover:#666;--labelCol:#777;--csitemBorder:#555;--uiGraphics:rgb(255,255,255,0.25);--bookmarkCol:#dd1010;--buttonDisabledCol:#333;--diceFill:black;--diceStroke:#aaa;--imgopacity:.7}img{opacity:var(--imgopacity)}.dice{stroke:var(--diceStroke);stroke-width:5;fill:var(--diceFill)}.diceNum{fill:var(--diceStroke)}.atdie{display:inline-block;position:relative;width:100px;height:100px}.dieFace{position:absolute;top:0;left:0;width:100px;height:100px;user-select:none}dialog{background-color:var(--pageCol);border-radius:15px;position:fixed;padding:0;max-height:calc(100vh - 40px);min-height:200px;width:100%;max-width:700px;box-shadow:1px 1px 20px black;overflow:visible;color:var(--textCol)}.peekContent{text-align:justify;width:calc(100% - 40px);padding:20px;padding-top:40px;overflow:scroll;max-height:calc(100vh - 100px)}.peekControls{position:absolute;top:-15px;width:100%;max-width:700px}dialog::backdrop{background:rgba(0,0,0,0.5)}body{line-height:1.2;font-size:22px;color:var(--textCol);padding:0;margin:0;text-align:center;background-color:var(--pageCol);font-family:serif}button{min-height:40px;padding:10px;border:2px solid var(--panelBorderCol);border-radius:10px;font-size:12pt;background-color:var(--buttonCol);color:var(--panelBorderCol)}button:hover{background-color:var(--panelElementHover)}button:disabled{color:var(--buttonDisabledCol)}a{color:var(--linkCol);text-decoration-style:dotted}.passageLink{background:none !important;padding:0 !important;border-radius:inherit;border:0;color:var(--linkCol);text-decoration:underline;text-decoration-style:dotted;cursor:pointer;font:inherit;font-size:inherit;min-height:inherit}.passageTitle{font-size:28px;margin:10px auto;width:100%;max-width:700px;text-align:center}.passage{margin:10px auto;text-align:justify;max-width:700px;padding-left:20px;padding-right:20px}.pagePanel{position:absolute;top:0;left:250px;right:500px;padding-left:30px;padding-right:30px;padding-bottom:calc(10px + env(safe-area-inset-bottom))}.atmenuButton{position:relative;margin:30px auto;text-align:center;width:50px;height:50px;border-radius:100%;cursor:pointer;border:0;padding:0;background-color:transparent}.atmenuButton:hover{background-color:rgba(255,255,255,0.4)}.pageTurnPanel{position:fixed;height:50px;width:50px;user-select:none;cursor:pointer;bottom:calc(10px + env(safe-area-inset-bottom));border-radius:100%;border:0;padding:0;background-color:transparent}.pageTurnPanel:hover{background-color:rgba(255,255,255,0.4)}.uiSVG{fill:var(--uiGraphics)}.uiSVGLine{stroke:var(--uiGraphics);stroke-width:5px;stroke-linecap:round}.bookmark{transform:translate(0,-15px);fill:#00000000;stroke:var(--uiGraphics);stroke-width:5px}button:hover .bookmark{fill:#00000000;transform:translate(0,-10px);stroke:var(--bookmarkCol)}.bookmark[type=on]{transform:translate(0,-5px);fill:var(--bookmarkCol);stroke:var(--bookmarkCol)}button:hover .bookmark[type=on]{transform:translate(0,-0);fill:var(--bookmarkCol);stroke:var(--bookmarkCol)}.rightPanel{position:fixed;top:0;right:0;background-color:var(--panelCol);width:500px;height:100vh;overflow-y:scroll;border-left:2px solid var(--panelBorderCol);padding-top:15px;padding-bottom:15px}.panelTabsRight{position:fixed;transform-origin:right bottom;transform:rotate(-90deg);top:-20px;right:498px}.panelTabsLeft{position:fixed;transform-origin:left bottom;transform:rotate(90deg);top:-20px;left:250px}.tabButton{background-color:var(--panelCol);border:2px solid var(--panelBorderCol);border-top-right-radius:10px;border-top-left-radius:10px;border-bottom-right-radius:0;border-bottom-left-radius:0;border-bottom:2px solid var(--panelCol);padding:15px;cursor:pointer;vertical-align:bottom}.tabButton[type=inactive]:hover{transform:translate(0,-2px);padding-bottom:15px;opacity:1}.tabButton[type=inactive]{transform:translate(0,-2px);padding-bottom:5px;opacity:.65}.csitem{border:2px solid var(--csitemBorder);border-radius:7px;display:inline-block;padding:5px;margin:2px}.csitem[type=notes]{width:450px}.csitem[type=text]{width:450px}.cslabel{font-size:16pt;font-style:italic;font-weight:bold;width:100%;color:var(--labelCol);user-select:none}.csToggleContainer{display:inline-block;position:relative;padding:20px;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;border-radius:100%}.csToggleContainer input{position:absolute;opacity:0;cursor:pointer;height:0;width:0}.csToggle{position:absolute;top:3px;left:3px;height:30px;width:30px;background-color:transparent;border-radius:100%;border:2px solid var(--textCol)}.csToggleContainer:hover input ~ .csToggle{background-color:var(--panelElementHover)}.csToggleContainer:focus-within{outline:1px solid var(--panelElementHover)}.csToggle:after{content:"";position:absolute;display:none}.csToggleContainer input:checked ~ .csToggle:after{display:block}.csToggleContainer .csToggle:after{left:5px;top:5px;width:20px;height:20px;background-color:var(--textCol);border-radius:100%}.csInputField{width:100px;height:40px;font-size:30px;text-align:center;border:0}.csInputField[type=text]{width:100%;max-height:40px;font-size:30px;overflow:hidden;text-overflow:clip;white-space:nowrap}.csInputField[type=number]{width:100%;min-width:100px;max-height:40px;font-size:30px;overflow:hidden;text-overflow:clip;white-space:nowrap}.csInputField[type=notes]{text-align:left;width:100%;height:inherit;min-height:150px;font-size:25px;font-family:sans-serif}.leftPanel{position:fixed;top:0;left:0;background-color:var(--panelCol);width:250px;height:100vh;border-right:2px solid var(--panelBorderCol);padding:0}.historyControls{width:100%;height:40px;padding-top:15px;padding-bottom:15px;top:0;background-color:var(--panelCol)}.bookmarksTab{height:100vh;overflow-y:scroll}.historyList{border-top:1px solid var(--panelBorderCol);margin:5px;padding-top:0;height:calc(100vh - 80px);overflow-y:scroll}.historyElement{background-color:var(--panelElementA);text-align:left;padding:10px;border-bottom:1px solid var(--panelBorderCol);user-select:none}.historyElementActive{background-color:var(--panelElementActive);text-align:left;padding:15px;padding-top:10px;padding-bottom:10px;border:1px solid var(--panelBorderCol);border-top:0;user-select:none}.historyElement:nth-of-type(odd){background-color:var(--panelElementB)}.historyElement:hover{background-color:var(--panelElementHover)}.historyElementActive:hover{background-color:var(--panelElementHover)}.narrowDisplayTabs{position:fixed;table-layout:fixed;width:100%;text-align:center;border-bottom:1px solid var(--panelBorderCol)}.narrowDisplayTab{display:table-cell;padding:20px;background-color:var(--panelElementA);text-align:center;vertical-align:middle;user-select:none}.narrowDisplayTab:hover{background-color:var(--panelElementHover)}.modalMenu{text-align:center;vertical-align:middle;width:100%;height:100%}.settingsTable{table-layout:fixed;width:100%}.settingsTitles{padding:15px;display:table-cell;text-align:right;vertical-align:top;width:35%}.settingsOptions{padding:15px;display:table-cell;text-align:left;vertical-align:text-top}.searchTitle{text-align:left;font-weight:bold;font-size:larger}.searchPageNum{float:right;font-style:italic}.searchSample{text-align:left;font-style:italic} </adventuretomestyle> </head> <body class="dark-theme || light-theme"> <div id=adventureTomeLoading style=width:100vw;height:100vh;text-align:center;padding-top:50vh>Loading...</div> <div id=adventureTomeView hidden> <div class=pagePanel id=pagePanel> <div hidden id=adventuretomewarnings align=center style=padding:20px> <div style=background-color:red;color:#000;width:50%;padding:20px;border-radius:20px><b>WARNING:</b> <div id=adventuretomewarningstext align=left width=300px></div> <br><button onclick=closeWarnings()>Dismiss</button></div> </div> <p id=currentPage></p> <button id=pageLeftDiv title="Previous page." class=pageTurnPanel onclick=previousPage() style=left:0> <svg height=50 width=50> <polygon points="15,25 35,15 35,35" class=uiSVG /> </svg> </button> <button class=atmenuButton title="Show game menu." onclick=showATMenu()> <svg height=50 width=50> <g class=uiSVGLine><line x1=12 y1=15 x2=38 y2=15 /><line x1=12 y1=25 x2=38 y2=25 /><line x1=12 y1=35 x2=38 y2=35 /></g> </svg> </button> <button id=pageRightDiv title="Next page." class=pageTurnPanel onclick=nextPage() style=right:0> <svg height=50 width=50> <polygon points="35,25 15,15 15,35" class=uiSVG /> </svg> </button> <button id=bookmarkButton class=atmenuButton onclick=bookmarkCurrent() style=background-color:transparent;position:absolute;top:0;right:70px;padding:0;margin:0><svg id=bookmarkButtonImg class=bookmark height=50 width=50> <polygon points="5,0 45,0 45,45 25,30, 5,45"/> </svg> </button> </div> <div hidden id=rightPanel class=rightPanel></div> <div id=rightPanelTabs class=panelTabsRight> </div> <div id=leftPanel class=leftPanel hidden> <div id=historyTab> <div class=historyControls> <button id=undoButton onclick=undo() title="Go back a step through the game history.">Undo</button> <button onclick=redo() id=redoButton title="Go forward a step through the game history.">Redo</button> </div> <div class=historyList id=historyList></div> </div> <div id=bookmarksTab class=bookmarksTab hidden></div> </div> <div id=leftPanelTabs class=panelTabsLeft> <button id=historyTabButton onclick="goPanelLeft('history')" class=tabButton type=inactive title="View or step through game history.">History</button> <button id=bookmarksTabButton onclick="goPanelLeft('bookmarks')" class=tabButton type=inactive title="Bookmarked pages.">Bookmarks</button> </div> <div hidden id=narrowDisplayTabs class=narrowDisplayTabs> <span class=narrowDisplayTab onclick="goTab('history')">History</span> <span class=narrowDisplayTab onclick="goTab('bookmarks')">Bookmarks</span> <span class=narrowDisplayTab onclick="goTab('page')">Page</span> <span class=narrowDisplayTab onclick="goTab('sheet')" id=narrowCharaSheetButton>Character Sheet</span> </div> <dialog id=peekDialog> <div id=peekContent class=peekContent></div> <div id=peekControls class=peekControls> <button id=peekGoBack onclick=showPreviousATMenu()>Go Back</button> <button id=peekBookmark>Bookmark this</button> <button id=peekTurnTo>Turn to this page</button> <button onclick=closePeek()>Close</button> </div> </dialog> <template id=atMenu> {{menulinks}} <button onclick="showATMenu('atturntoMenu')" style=width:100%>Turn To...</button><br> <button onclick="showATMenu('searchMenu')" style=width:100%>Search...</button><br> <button id=darkModeButton onclick=toggleDarkMode() style=width:100%>{{darkmodemsg}}</button><br> <button onclick="showATMenu('settingsMenu')" style=width:100%>Settings</button> </template> <template id=atclearHistoryMenu> <div class=modalMenu><h3>Clear Game Progress?</h3><b>Warning:</b><br>This cannot be undone and will erase all game history and sheet changes.<br><br><button onclick=clearGameHistory()>Clear Game Progress</button> <button onclick='showATMenu("settingsMenu")'>Cancel</button></div> </template> <template id=settingsMenu> <div class=modalMenu> <h3>Settings</h3> <table class=settingsTable> <tr><td class=settingsTitles><label for=fontsizes>Text Size:</label></td> <td class=settingsOptions> <button onclick=fontSizeDown()><small><small>A</small></small></button><input name=fontsizes id=fontsizes onchange=setFontSizeSetting() value={{fontsize}}><button onclick=fontSizeUp()><large><large>A</large></large></button> </td> </tr> <tr><td class=settingsTitles><label for=fontfamily>Font:</label></td> <td class=settingsOptions> <div id=fontinputpreset> <select name=fontfamily id=fontfamily oninput=setFontFamilySetting()> <option value=atdefaultfont {{fontdselected}}>[Default]</option> <option value=atcustomfont {{fontcselected}}>[Custom]</option> <option value=serif {{font0selected}}>Serif</option> <option value=sans-serif {{font1selected}}>Sans-Serif</option> <option value=monospace {{font2selected}}>Monospace</option> <option value=cursive {{font3selected}}>Cursive</option> <option value=fantasy {{font4selected}}>Fantasy</option> </select> </div> <div id=customfontdiv {{fontcustomhidden}}><label for=customFont><i>Enter the name of a font installed on your device:</i></label><br> <input name=customFont id=customFont oninput=setFontFamilySetting() value={{customfont}}></div></td> </tr> <tr><td class=settingsTitles>Layout:</td> <td class=settingsOptions><input name=layoutradios oninput=setLayoutSetting() type=radio id=layoutAuto name=layoutTypeToggle {{layoutautoradiocheck}}> <label for=layoutAuto>Auto</label> <br> <input name=layoutradios oninput=setLayoutSetting() type=radio id=layoutFull name=layoutTypeToggle {{layoutfullradiocheck}}> <label for=layoutFull>Full</label> <br> <input name=layoutradios oninput=setLayoutSetting() type=radio id=layoutMin name=layoutTypeToggle {{layoutminradiocheck}}> <label for=layoutMin>Minimal</label></td></tr> <tr {{diceanimsettinghidden}}><td class=settingsTitles>Dice Animation:</td> <td class=settingsOptions><input name=diceanimradios oninput=setDiceAnimSetting() type=radio id=diceanim2 {{diceanim2radiocheck}}> <label for=diceanim2>Normal</label> <br> <input name=diceanimradios oninput=setDiceAnimSetting() type=radio id=diceanim1 {{diceanim1radiocheck}}> <label for=diceanim1>Simple</label> <br> <input name=diceanimradios oninput=setDiceAnimSetting() type=radio id=diceanim0 {{diceanim0radiocheck}}> <label for=diceanim0>None</label></td></tr> </table> <button onclick="showATMenu('atclearHistoryMenu')">Clear Game Progress</button><br> <br> <button onclick=showATMenu()>Go Back</button> </div> </template> <template id=atturntoMenu> <div class=modalMenu> <h3>Turn to...</h3> <input type=radio id=turntopassageradio name=targetturntype value=Passage {{atpassageradiocheck}}> <label for=turntopassageradio>Passage</label> <input type=radio id=turntopageradio name=targetturntype value=Page {{atpageradiocheck}}> <label for=turntopageradio>Page</label><br> <input id=turnToInputNumber type=number value=69420><br><br> <button onclick=turnToFromUI()>Turn</button> <button onclick=showATMenu()>Cancel</button></div> </template> <template id=searchMenu> <div class=modalMenu> <input id=pagesearchinput name=pagesearchinput onsubmit=beginPageSearch() style=width:50% title="Search text input" value={{searchterm}}> <button onclick=beginPageSearch()>Search</button><br> <input name=viewUnvisited id=viewUnvisited type=checkbox onchange=toggleSearchUnvisited() {{viewunvisitedchecked}}><label for=viewUnvisited>Show unvisited excerpts</label><br> <progress id=searchprogress value=0 max=1 style=width:100% hidden></progress> <div id=pageSearchResults></div> <br><button onclick=showATMenu()>Go Back</button> </div> </template> <div id=StoryScriptsNode></div> <div id=CharacterSheetScriptsNode></div> <div id=PassageScriptsNode></div> <div id=PeekScriptsNode></div> </div> <script>/* uglified */
function e(t){let n=0;for(let e=0;e<t.length;e++){var l=t.charCodeAt(e);n=(n<<5)-n+l,n&=n}return n}var I=e(window.location.origin+window.location.pathname).toString();function r(e){return localStorage.getItem(I+e)}function i(e,t){localStorage.setItem(I+e,t)}function s(e){localStorage.removeItem(I+e)}var d=!0,_=(window.matchMedia("(prefers-color-scheme: dark)").matches||(d=!1),"y"==r("darkmode")&&(d=!0),(d="n"==r("darkmode")?!1:d)||document.body.classList.remove("dark-theme"),"Disable Dark Mode"),A="Enable Dark Mode",P=[],F=0,Q=[],U=document.getElementsByTagName("tw-passagedata"),D=[],Z=0,ee=-1,te=-1,V=[],ne=0,o=[],le=new URLSearchParams(window.location.search);function N(e){var n=[-1,-1];if("number"==typeof e)0<=e&&e<P.length&&(n[0]=e);else for(let t=0;t<U.length;t++)if(e==D[t]){n[1]=t;for(let e=0;e<P.length;e++)P[e].passageIndex==t&&(n[1]=-1,n[0]=e)}return n}function turnTo(e=-1){$&&closePeek();var t=N(e);0<=t[0]?showPage(t[0]):0<=t[1]?peek(e):q("Could not find page or passage to display '"+e+"'.")}var $=!1,k=document.getElementById("peekDialog"),B=(k.addEventListener("close",e=>{He(),lt(!1,!0)}),document.getElementById("peekContent")),w=document.getElementById("peekGoBack"),C=document.getElementById("peekTurnTo"),l=document.getElementById("peekBookmark"),L=-1,M="";function peek(e=-1,t=""){$&&closePeek();var n=N(e);if(et=Ze.PEEK,L=n[0],M=t,w.style.display="none",""!=t&&(w.style.display="inline"),C.removeAttribute("onclick"),C.style.display="none",l.removeAttribute("onclick"),l.style.display="none",0<=n[0])B.innerHTML=qe(P[n[0]].passageIndex,n[0]),C.setAttribute("onclick","showPage("+n[0]+")"),C.style.display="inline",Yt(),l.setAttribute("onclick","bookmarkPeek("+n[0]+")"),l.style.display="inline";else{if(!(0<n[1]))return void q("Couldn't find page/passage '"+e+"'.");B.innerHTML=qe(n[1],-1)}$=!0,k.showModal(),lt(!0,!0)}function closePeek(){$=!1,k.close()}function turnToFromUI(){let e=+document.getElementById("turnToInputNumber").value;document.getElementById("turntopassageradio").checked&&(e+=ne),turnTo((e=Math.min(Math.max(e,1),P.length))-1)}function setLayoutSetting(){document.getElementById("layoutAuto").checked&&(J="auto"),document.getElementById("layoutFull").checked&&(J="full"),document.getElementById("layoutMin").checked&&(J="min"),x(),i("atlayoutSetting",J)}function setDiceAnimSetting(){document.getElementById("diceanim2").checked&&(z=2),document.getElementById("diceanim1").checked&&(z=1),i("atdiceanimSetting",z=document.getElementById("diceanim0").checked?0:z)}var W=100;const S=10,O=1500;var K="atdefaultfont",ae="";function fontSizeUp(){W+=10,W=Math.min(O,W),en(),R(),i("atfontsizeSetting",W)}function fontSizeDown(){W-=10,W=Math.max(S,W),en(),R(),i("atfontsizeSetting",W)}function setFontSizeSetting(){let e=document.getElementById("fontsizes").value.replace("%","");isNaN(Number(e))&&(e=W),e=Math.max(S,Number(e)),e=Math.min(O,e),W=e,isNaN(W)&&(W=100),R(),en(),i("atfontsizeSetting",W)}function R(){document.getElementById("fontsizes").value=W+"%"}function setFontFamilySetting(){K=document.getElementById("fontfamily").value,ae=document.getElementById("customFont").value,en(),i("atfontfamilySetting",K),i("atcustomfontSetting",ae);var e=document.getElementById("customfontdiv");null!=e&&(e.hidden="atcustomfont"!=K)}function showPreviousATMenu(){showATMenu(M)}function showATMenu(e="atMenu"){var l="checked",t="selected";let a=document.getElementById(e).innerHTML;if("searchMenu"==e){if(a=a.replace("{{searchterm}}",u),Se&&(a=a.replace("{{viewunvisitedchecked}}",l)),0<c.length){let t="";for(let e=0;e<c.length;e++)t+=Pe(c[e][0],c[e][1],c[e][2]);var n=a.indexOf("pageSearchResults")+19;a=a.slice(0,n)+t+a.slice(n)}}else He();if("atMenu"==e){let t="";for(let e=0;e<Q.length;e++)t+=`<button style="width:100%" onclick='peek("${Q[e]}","atMenu")'>${Q[e]}</button><br>`;a=a.replace("{{menulinks}}",t),a=d?a.replace("{{darkmodemsg}}",_):a.replace("{{darkmodemsg}}",A)}if("settingsMenu"==e&&(a=a.replace("{{fontsize}}",W+"%"),"atdefaultfont"==K&&(a=a.replace("{{fontdselected}}",t)),a="atcustomfont"==K?a.replace("{{fontcselected}}",t):a.replace("{{fontcustomhidden}}","hidden"),"serif"==K&&(a=a.replace("{{font0selected}}",t)),"sans-serif"==K&&(a=a.replace("{{font1selected}}",t)),"monospace"==K&&(a=a.replace("{{font2selected}}",t)),"cursive"==K&&(a=a.replace("{{font3selected}}",t)),a=(a="fantasy"==K?a.replace("{{font4selected}}",t):a).replace("{{customfont}}",ae),"auto"==J&&(a=a.replace("{{layoutautoradiocheck}}",l)),"full"==J&&(a=a.replace("{{layoutfullradiocheck}}",l)),"min"==J&&(a=a.replace("{{layoutminradiocheck}}",l)),Te||(a=a.replace("{{diceanimsettinghidden}}","hidden")),2==z&&(a=a.replace("{{diceanim2radiocheck}}",l)),1==z&&(a=a.replace("{{diceanim1radiocheck}}",l)),0==z)&&(a=a.replace("{{diceanim0radiocheck}}",l)),"atturntoMenu"==e){let e="",t=l,n=F;0<=F-ne&&F-ne<Z&&(n-=ne,e=l,t=""),a=(a=(a=a.replace("{{atpassageradiocheck}}",e)).replace("{{atpageradiocheck}}",t)).replace("69420",n+1)}H(a),"searchMenu"==e&&Re()}function H(e){$&&closePeek(),w.style.display="none",C.removeAttribute("onclick"),C.style.display="none",l.removeAttribute("onclick"),l.style.display="none",B.innerHTML=e,$=!0,k.showModal()}var G=document.getElementById("adventuretomewarnings"),ie=document.getElementById("adventuretomewarningstext");function q(e){G.hidden=!1,ie.innerHTML+="<hr>"+e}function closeWarnings(){ie.innerHTML="",G.hidden=!0}var se=!1;function re(e){return e=e.replaceAll("&","AT_AMP_HERE").replaceAll("'","&apos;").replaceAll('"',"&quot;").replaceAll("AT_AMP_HERE","&amp;")}function de(){var d=[],l=[];let o=[],c=[];var u=[];let h=!1;var g=[],e=document.getElementsByTagName("tw-storydata")[0],p=(e.hasAttribute("name")&&addSwap("$$story_name$$",e.getAttribute("name")),e.hasAttribute("ifid")&&addSwap("$$story_ifid$$",e.getAttribute("ifid")),e.getAttribute("startnode"));let m=-1;var f=[],v=[],y=[];let b=!1,E=!1,T=!1;var x=[],I=[],_=[];let A=0;var N=[],$=[],k=[],B=[],w=[];let C=-1,L=-1,M=-1,S=-1;for(let r=0;r<U.length;r++){let t=!0,n=0,l=!1,a=!1,i=!0,s=!1;var O=re(U[r].getAttribute("name"));if(U[r].setAttribute("name",O),D.push(O),U[r].getAttribute("pid")==p&&(t=!1,m=r),"gb-front-cover"==O&&-1==C&&(C=r,t=!1),"gb-introduction"==O&&-1==L&&(L=r,t=!1),"gb-rear"==O&&-1==M&&(M=r,t=!1),"gb-rear-cover"==O&&-1==S&&(S=r,t=!1),"gb-settings"==O&&(t=!1),"pageheader"==O&&(ee=r,t=!1,i=!1),"pagefooter"==O&&(te=r,t=!1,i=!1),"passagetextswaps"==O&&(Le(U[r].innerHTML),t=!1,i=!1),U[r].hasAttribute("tags")){var R,H,G=U[r].getAttribute("tags").split(" ");for(let e=0;e<G.length;e++)G[e]=G[e].toLowerCase(),"hidden"!=G[e]&&"skip"!=G[e]||(t=!1,i=!1),!t||"ending"!=G[e]&&"last"!=G[e]||(f.push(r),t=!1),G[e].includes("charactersheet")&&(V.push(r),t=!1,i=!1,1<G[e].split("_").length&&NaN!=parseInt(G[e].split("_")[1])?(g.push(parseInt(G[e].split("_")[1])),h=!0):g.push(-99)),t&&G[e].includes("frontmatter")&&(o.push(r),t=!1,1<G[e].split("_").length&&NaN!=parseInt(G[e].split("_")[1])?(x.push(parseInt(G[e].split("_")[1])),b=!0):x.push(-99)),t&&G[e].includes("backmatter")&&(c.push(r),t=!1,1<G[e].split("_").length&&NaN!=parseInt(G[e].split("_")[1])?(I.push(parseInt(G[e].split("_")[1])),E=!0):I.push(-99)),t&&G[e].includes("fixednumber")&&1<G[e].split("_").length&&NaN!=parseInt(G[e].split("_")[1])&&(N.push(r),R=parseInt(G[e].split("_")[1]),$.push(R),A=Math.max(R,A),t=!1),t&&G[e].includes("chapter_")&&("start"==(R=G[e].substring(8,G[e].length))?(t=!1,l=!0):"end"==R?(t=!1,a=!0):isNaN(parseInt(R))||(n=+parseInt(R))),"notitle"==G[e]&&k.push(r),"noheader"==G[e]&&B.push(r),"nofooter"==G[e]&&w.push(r),"menulinked"!=G[e].substr(0,10)&&"contents"!=G[e].substr(0,8)||(Q.push(O),1<G[e].split("_").length&&NaN!=parseInt(G[e].split("_")[1])?(_.push(parseInt(G[e].split("_")[1])),T=!0):_.push(-99)),t&&1<=G[e].length&&!isNaN(parseInt(G[e]))&&(N.push(r),H=parseInt(G[e]),$.push(H),A=Math.max(H,A),t=!1),"bookmarked"!=G[e]&&"fixedbookmark"!=G[e]||(s=!0)}if(s&&i&&u.push(r),t||-1!=l||-1!=a){for(;d.length<n+1;)d.push([]),v.push([]),y.push([]);l&&(v[n].push(r),t=!1),a&&(y[n].push(r),t=!1)}t&&d[n].splice(Math.floor((d[n].length+1)*dt()),0,r)}for(let t=0;t<d.length;t++){for(let e=0;e<v[t].length;e++)d[t].unshift(v[t][e]);for(let e=0;e<y[t].length;e++)d[t].push(y[t][e])}for(let t=0;t<d.length;t++)for(let e=0;e<d[t].length;e++)l.push(d[t][e]);-1<m&&l.unshift(m);for(let e=0;e<f.length;e++)l.push(f[e]);let a=0;for(;a<N.length;){let t=A+1,n=0;for(let e=0;e<N.length;e++)$[e]<t&&(t=$[e],n=e);l.splice(t-1,0,N[n]),a++,$[n]=A+10}b&&(o=ot(o,x)),E&&(c=ot(c,I)),T&&(Q=ot(Q,_)),we(C,Y.GBFRONT);for(let e=0;e<o.length;e++)we(o[e],Y.FRONTMATTER);we(L,Y.GBINTRO),ne=P.length,Z=l.length;for(let e=0;e<l.length;e++)we(l[e],Y.SHUFFLEDPASSAGE,e+1);for(let e=0;e<c.length;e++)we(c[e],Y.BACKMATTER);we(M,Y.GBREAR),we(S,Y.GBREARCOVER);for(let e=0;e<P.length;e++)k.includes(P[e].passageIndex)&&(P[e].showTitle=!1),B.includes(P[e].passageIndex)&&(P[e].showHeader=!1),w.includes(P[e].passageIndex)&&(P[e].showFooter=!1);if(0<X.length)for(let t=0;t<U.length;t++)for(let e=0;e<X.length;e++)D[t].includes(X[e][0])&&q(`The passage titled '${D[t]}' contains the swapped text '${X[e][0]}', links to this passage will be broken.`);h&&(V=ot(V,g));for(let e=0;e<V.length;e++)ce(e);for(let e=0;e<V.length;e++)ue(e);Bt.innerHTML=D[V[0]],showPage(F),gt();var t=le.get("page");if(null!=t)for(let e=0;e<P.length;e++)t==e+1&&F!=e&&(j=[],showPage(e));if(null!=r("atbkmk_0")){let e=0;for(;null!=r("atbkmk_"+e);)Qt(r("atbkmk_"+e)),e++}else for(let e=0;e<u.length;e++)Qt(D[u[e]]);Kt(),null!=r("tabRightCurrent")&&goPanelRight(r("tabRightCurrent")),null!=r("tabLeftCurrent")&&goPanelLeft(r("tabLeftCurrent")),wt=!0,null!=r("atfontsizeSetting")&&(W=Number(r("atfontsizeSetting")),isNaN(W))&&(W=100),null!=r("atfontfamilySetting")&&(K=r("atfontfamilySetting")),null!=r("atcustomfontSetting")&&(ae=r("atcustomfontSetting")),null!=r("atlayoutSetting")&&(J=r("atlayoutSetting")),null!=r("atdiceanimSetting")&&(z=parseInt(r("atdiceanimSetting"))),en(),ge(),se=!0,j.push([document.getElementById("twine-user-script"),Ze.STORY]),lt()}var oe=new DOMParser,p=[];function ce(e){let t=U[V[e]].innerHTML,n=!1;for(var l=[];!n;){var a=t.toLowerCase().indexOf("&lt;csitems&gt;"),i=t.toLowerCase().indexOf("&lt;/csitems&gt;");a<0||i<0?n=!0:(a=t.substring(a,i+16),l.push(a),t=t.replace(a,""))}U[V[e]].innerHTML=t;for(let t=0;t<l.length;t++){let e=l[t];e=e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"');for(var s=oe.parseFromString(e,"text/html").documentElement.getElementsByTagName("csitems");0<s.length;){var r=["number","text","die","uneditable","notes","toggle"];for(let t=0;t<r.length;t++){var d=s[0].getElementsByTagName(r[t]);for(let e=0;e<d.length;e++)ye(d[e],r[t])}s[0].remove()}}}function ue(e){et=Ze.SHEET;let t=qe(V[e],0);for(let e=0;e<p.length;e++)for(;t.includes("$$"+p[e].name+"$$");)a++,t=t.replace("$$"+p[e].name+"$$",be(p[e]));t=`<div id='atcharsheet_${e}' hidden>${t}</div>`,E.innerHTML+=t,$t.innerHTML=`<button onclick='goPanelRight(${e})' id='atcharsheettab_${e}' class='tabButton' type='inactive' title='Show or hide this character sheet.'>${D[V[e]]}</button> `+$t.innerHTML,lt()}var he=[];function ge(){for(let t=0;t<ve.length;t++){let e=ve[t][0];var n=p[m(ve[t][1])],l=document.querySelector(`[uiid=csinput_${e}]`);he.push({uiid:e,element:l,item:n,valIndex:ve[t][2]}),"toggle"==n.type?l.addEventListener("input",()=>{pe(event,"input",e)}):(l.addEventListener("focusout",()=>{pe(event,"focusout",e)}),l.addEventListener("keydown",()=>{pe(event,"keydown",e)}),l.addEventListener("paste",()=>{pe(event,"paste",e)}))}ve=[]}function pe(e,t,n=-1){csEditable=null;for(let e=0;e<he.length;e++)he[e].uiid==n&&(csEditable=he[e]);"input"==t&&"toggle"==csEditable.item.type?fe(csEditable):"paste"==t&&"notes"!=csEditable.item.type?(e.preventDefault(),me(e.clipboardData.getData("text/plain").replace(/(?:\r\n|\r|\n)/g," "))):("notes"==csEditable.item.type||"keydown"!=t||"Enter"!=e.code&&"NumpadEnter"!=e.code||e.preventDefault(),"notes"==csEditable.item.type||"keydown"!=t||"Enter"!=e.code&&"NumpadEnter"!=e.code?"focusout"==t&&fe(csEditable):(fe(csEditable),deselectCSUI(csEditable.uiid)))}function me(e){var t=window.getSelection(),n=t.getRangeAt(0),e=(n.deleteContents(),document.createTextNode(e));n.insertNode(e),t.modify("move","right","character")}function fe(t){if("toggle"==t.item.type){let e=0;t.element.checked&&(e=1),csSet(t.item.name,e,t.valIndex)}else"number"==t.item.type?""==t.element.textContent||isNaN(Number(t.element.textContent))?t.element.textContent=t.item.val[t.valIndex]:csSet(t.item.name,+t.element.textContent,t.valIndex):"notes"==t.item.type?csSet(t.item.name,t.element.innerHTML,t.valIndex):csSet(t.item.name,t.element.textContent,t.valIndex)}var ve=[];function ye(e,t){var n={name:"",label:"",val:[""],type:t,alt:"",itemstyle:"",labelstyle:"",inputstyle:"",isArray:!1,nohistory:!1};if(e.hasAttribute("name")&&(n.name=e.getAttribute("name")),e.hasAttribute("label")&&(n.label=e.getAttribute("label")),e.hasAttribute("value")&&(n.val[0]=e.getAttribute("value")),e.hasAttribute("alt")&&(n.alt=e.getAttribute("alt")),e.hasAttribute("itemstyle")&&(n.itemstyle=e.getAttribute("itemstyle")),e.hasAttribute("labelstyle")&&(n.labelstyle=e.getAttribute("labelstyle")),e.hasAttribute("inputstyle")&&(n.inputstyle=e.getAttribute("inputstyle")),e.hasAttribute("array")&&(n.isArray="false"!=e.getAttribute("array")),e.hasAttribute("nohistory")&&(n.nohistory="false"!=e.getAttribute("nohistory")),n.isArray&&(n.val=[],e.hasAttribute("value")&&(n.val=e.getAttribute("value").split("|")),e.hasAttribute("values"))&&(n.val=e.getAttribute("values").split("|")),"die"==n.type){n.nohistory=!0,n.dieType="6pips",e.hasAttribute("dieType")&&(n.dieType=e.getAttribute("dieType")),n.dieFaces=n.dieType.split("|").length,"6pips"==n.dieType&&(n.dieFaces=6),"coin"==n.dieType&&(n.dieFaces=2),1<n.dieType.length&&"d"==n.dieType[0]&&(isNaN(parseInt(n.dieType.substring(1)))||(n.dieFaces=parseInt(n.dieType.substring(1)),n.dieType="dX")),n.dieBG="",e.hasAttribute("dieBG")&&(n.dieBG=e.getAttribute("dieBG"));for(let e=0;e<n.val.length;e++)isNaN(parseInt(n.val[e]))?n.val[e]=n.dieFaces:n.val[e]=parseInt(n.val[e]),n.val[e]=Math.min(Math.max(1,n.val[e]),n.dieFaces)}if("toggle"==n.type)for(let e=0;e<n.val.length;e++)"on"==n.val[e].toLowerCase()?n.val[e]=1:n.val[e]=0;n.initialVals=[];for(let e=0;e<n.val.length;e++)n.initialVals.push(n.val[e]);if(n.nohistory){for(let e=0;e<n.val.length;e++)null!=r("csval_"+e+"_"+n.name)&&(n.val[e]=r("csval_"+e+"_"+n.name));let e=n.val.length;for(;null!=r("csval_"+e+"_"+n.name);){var l=r("csval_"+e+"_"+n.name);e<n.val.length?n.val[e]=l:n.val.push(l),e++}}""==n.name?q("An interactible type of csitem listed for the character sheet has no 'name' attribute and won't be listed."):-1!=m(n.name,!1)?q("A csitem named '"+n.name+"' already exists, this one will be disregarded."):p.push(n)}function be(i){let s=i.name,e="",n=(""!=i.itemstyle&&(e=`style='${i.itemstyle}' `),""),t=(""!=i.labelstyle&&(n=`style='${i.labelstyle}' `),""),l=(""!=i.inputstyle&&(t=`style='${i.inputstyle}' `),"");if(""!=i.alt&&(l="title='"+i.alt+"' "),"die"==i.type){Te=!0,s="<div style='display:inline-block;'>";for(let a=0;a<i.val.length;a++){var r=i.val[a];let e="",t="";var d,o,c,u,h,g="style='visibility:hidden;'";let n="",l=!1;if("coin"==i.dieType&&(e="<div class='dieFace'><svg width=100px height=100px><circle cx=50 cy=50 r='45' class='dice' /></svg></div>",n=1==r?"":g,t+=`<div id='die_${i.name}_${a}_0' class='dieFace' ${n}><table width=100% height=100%><tr><td valign=middle>Tails</td></tr></table></div>`,n=2==r?"":g,t+=`<div id='die_${i.name}_${a}_1' class='dieFace' ${n}><table width=100% height=100%><tr><td valign=middle>Heads</td></tr></table></div>`,l=!0),"6pips"==i.dieType&&(e="<div class='dieFace'><svg width=100px height=100px><rect x=5 y=5 width='90' height='90' rx='15' class='dice' /></svg></div>",d="<circle cx='50' cy='50' r='10' class='diceNum' />",o="<circle cx='25' cy='25' r='10' class='diceNum' />",c="<circle cx='25' cy='75' r='10' class='diceNum' />",u="<circle cx='75' cy='25' r='10' class='diceNum' />",h="<circle cx='75' cy='75' r='10' class='diceNum' />",n=1==r?"":g,t+=`<div id='die_${i.name}_${a}_0' class='dieFace' ${n}><svg width=100px height=100px>${d}</svg></div>`,n=2==r?"":g,t+=`<div id='die_${i.name}_${a}_1' class='dieFace' ${n}><svg width=100px height=100px>${c+u}</svg></div>`,n=3==r?"":g,t+=`<div id='die_${i.name}_${a}_2' class='dieFace' ${n}><svg width=100px height=100px>${d+c+u}</svg></div>`,n=4==r?"":g,t+=`<div id='die_${i.name}_${a}_3' class='dieFace' ${n}><svg width=100px height=100px>${c+u+o+h}</svg></div>`,n=5==r?"":g,t+=`<div id='die_${i.name}_${a}_4' class='dieFace' ${n}><svg width=100px height=100px>${d+c+u+o+h}</svg></div>`,n=6==r?"":g,t+=`<div id='die_${i.name}_${a}_5' class='dieFace' ${n}><svg width=100px height=100px>${o+"<circle cx='25' cy='50' r='10' class='diceNum' />"+c+u+"<circle cx='75' cy='50' r='10' class='diceNum' />"+h}</svg></div>`,l=!0),"dX"==i.dieType){for(let e=0;e<i.dieFaces;e++)n=g,r==e+1&&(n=""),t+=`<div id='die_${i.name}_${a}_${e}' class='dieFace' ${n}>
<table width=100% height=100%><tr><td valign=middle style='font-size:55px;'>${e+1}</td></tr></table>
</div>`;l=!0}if(!l){var p=i.dieType.split("|");for(let e=0;e<p.length;e++)n=g,r==e+1&&(n=""),t+=`<div id='die_${i.name}_${a}_${e}' class='dieFace' ${n}>
<table width=100% height=100%><tr><td valign=middle>${p[e]}</td></tr></table>
</div>`;l=!0}""==(e=""!=i.dieBG?`<div class="dieFace">${i.dieBG}</div>`:e)&&(e='<div class="dieFace"><svg width=100px height=100px><polygon points="5 50, 25 90, 75 90, 95 50, 75 10, 25 10" class="dice" /></svg></div>'),s+=`<div class='atdie' id='die_${i.name}_${a}' onclick="rollDie('${i.name}',${a})" >${e+t}</div>`}1<i.val.length&&(s+=`<br><button onclick=rollDie('${i.name}',-1)>Roll</button>`),s+="</div>"}if("number"==i.type||"text"==i.type||"notes"==i.type||"toggle"==i.type){if(s=`<div id='cselement_${a}' onclick='selectCSUI("${a}")' class='csitem' type='${i.type}' `,""!=i.itemstyle&&(s+=`style='${i.itemstyle}' `),""!=i.alt&&(s+=`title='${i.alt}' `),s+=">",""!=i.label&&(s+=`<label class='cslabel' for='csinput_0_${i.name}' ${n}>${i.label}</label><br>`),"toggle"==i.type)for(let n=0;n<i.val.length;n++){a++;let e="",t=(1==i.val[n]&&(e="checked"),"Token");""!=i.label&&(t=i.label),s+=`<label class='csToggleContainer' title='${t} ${n+1}'>
<input type='checkbox' id='csinput_${n}_${i.name}' uiid='csinput_${a}' ${e} />
<span class='csToggle'></span>
</label>`,ve.push([a,i.name,n])}else for(let e=0;e<i.val.length;e++)a++,s+=`<div contenteditable='plaintext-only' class='csInputField' type='${i.type}' ${t} id='csinput_${e}_${i.name}' uiid='csinput_${a}' >${i.val[e]}</div>`,ve.push([a,i.name,e]);s+="</div>"}if("uneditable"==i.type){let t="hidden";for(let e=0;e<i.val.length;e++)""!=i.val[e]&&(t="");s=`<div class='csitem' id='cselement_${i.name}' ${e} ${l} ${t}>`,""!=i.label&&(s+=`<span class='cslabel' ${n}>${i.label}</span><br>`);for(let e=0;e<i.val.length;e++)s+=`<div displayid='csvaldisplay_${e}_${i.name}'>${i.val[e]}</div>`;s+="</div>"}return s}var Ee=[],Te=!1,z=2;function rollDie(n,t=0){var l=m(n);if(-1==t){if(-1!=l){let t=0;for(let e=0;e<p[l].val.length;e++)setTimeout(rollDie,t,n,e),t+=50}}else if(-1==xe(n,t)){var a=p[l].dieFaces,t={name:n,dieIndex:t,face:Math.floor(Math.random()*a),incrementDir:1,faceIncrementT:0,faceIncrementWait:1,faceCount:a,spinAng:0,bounceT:0,flip:!1,rollInterval:null,spinInterval:null,spinIndex:Ee.length,elem:document.getElementById("die_"+n+"_"+t)};.5<Math.random()&&(t.incrementDir=-1),a<=2&&(t.flip=!0);let e=1==z?40:10;t.rollInterval=setInterval(Ne,10,t),0<z&&(t.spinInterval=setInterval(Ie,e,t)),setTimeout(_e,500,t),Ee.push(t)}}function xe(t,n){for(let e=0;e<Ee.length;e++)if(t==Ee[e].name&&n==Ee[e].dieIndex)return e;return-1}function Ie(e){2==z?(e.spinAng+=15*e.incrementDir,e.bounceT+=.02):(e.spinAng+=30*e.incrementDir,e.bounceT+=.08);var t=-80*Math.abs(Math.sin(5*e.bounceT))*Math.min(1,2*(1-e.bounceT));e.flip?e.elem.style.transform=`translate(0,${t}px) rotate3d(1,0,0,${e.spinAng}deg)`:e.elem.style.transform=`translate(0,${t}px) rotate(${e.spinAng}deg)`,1<z&&(e.elem.style.filter="blur("+3*(1-e.bounceT)+"px)")}function _e(e){var t=xe(e.name,e.dieIndex);e.elem.style.transform="rotate(0deg) translate(0,0)",e.elem.style.filter="blur(0)",clearInterval(e.rollInterval),clearInterval(e.spinInterval),Ee.splice(t,1),csSet(e.name,e.face+1,e.dieIndex)}function Ae(n,l){for(let t=0;t<l.faceCount;t++){let e="hidden";l.face==t&&(e="visible"),document.getElementById("die_"+n+"_"+t).style.visibility=e}}function Ne(e){e.faceIncrementT++,e.faceIncrementT>=e.faceIncrementWait&&(e.faceIncrementT=0,e.faceIncrementWait*=1.7,e.face+=e.incrementDir,e.face>=e.faceCount&&(e.face=0),e.face<0&&(e.face=e.faceCount-1),Ae(e.name+"_"+e.dieIndex,e))}function m(t,e=!0){for(let e=0;e<p.length;e++)if(p[e].name==t)return e;return e&&q("Can't find csitem with name '"+t+"'."),-1}function $e(e,t){return t>=p[e].val.length&&(q("csitem '"+name+"' doesn't have index "+t+"."),!0)}function csGet(e,t=0){e=m(e);if(-1!=e&&!$e(e,t))return"number"==p[e].type?Number(p[e].val[t]):p[e].val[t]}function csSet(e,t,n=0){var l=m(e);if(-1!=l&&!$e(l,n)){var a=p[l].val[n];if("die"==p[l].type){if(isNaN(parseInt(t)))return;t=Math.max(1,Math.min(parseInt(t),p[l].dieFaces))}a!=t&&(p[l].val[n]=t,ke(p[l],n),p[l].nohistory?i("csval_"+n+"_"+e,p[l].val[n]):vt(v.CHANGEVALUE,p[l].val[n],a,e,n))}}function csSetTo(e,t,n=0,l=0){t=m(t);-1==t||$e(t,l)||csSet(e,p[t].val[l],n)}function csAppend(e,t,n=0){var l=m(e);-1==l||$e(l,n)||csSet(e,p[l].val[n]+""+t)}function csPrepend(e,t,n=0){var l=m(e);-1==l||$e(l,n)||csSet(e,t+""+p[l].val[n])}function csAdd(e,t,n=0){var l=m(e);-1==l||$e(l,n)||("number"!=p[l].type&&"die"!=p[l].type?q("Can't add to '"+e+"', it is not a number or die."):csSet(e,Number(p[l].val[n])+Number(t)))}function csSubtract(e,t,n=0){var l=m(e);-1==l||$e(l,n)||("number"!=p[l].type&&"die"!=p[l].type?q("Can't subtract from '"+e+"', it is not a number or die."):csSet(e,Number(p[l].val[n])-Number(t)))}function ke(n,l=0){if("die"==n.type)for(let t=0;t<n.dieFaces;t++){var a=document.querySelectorAll(`[id=die_${n.name}_${l}_${t}]`);for(let e=0;e<a.length;e++)n.val[l]==t+1?a[e].style.visibility="visible":a[e].style.visibility="hidden"}if("uneditable"==n.type){let t=!1;for(let e=0;e<n.val.length;e++)""!=n.val[e]&&(t=!0);var i=document.querySelectorAll(`[id=cselement_${n.name}]`);for(let e=0;e<i.length;e++)t?i[e].style.visibility="visible":i[e].style.visibility="hidden"}else{if("toggle"==n.type){var t=document.querySelectorAll(`[id=csinput_${l}_${n.name}]`);for(let e=0;e<t.length;e++)t[e].checked=1==n.val[l]}var s=document.querySelectorAll(`[id=csinput_${l}_${n.name}]`);for(let e=0;e<s.length;e++)document.activeElement!=s[e]&&("INPUT"==s[e].tagName?s[e].value=n.val[l]:s[e].innerHTML=n.val[l]);var r=document.querySelectorAll(`[displayid=csvaldisplay_${l}_${n.name}]`);for(let e=0;e<r.length;e++)r[e].innerHTML=n.val[l];l<n.val.length&&ke(n,l+1)}}var a=0;function selectCSUI(e){document.getElementById("cselement_"+e).contains(document.activeElement)||Be(Number(e)+1,!0)}function deselectCSUI(e){Be(e,!1)}function Be(e,t){e=document.querySelector(`[uiid=csinput_${e}]`);null!=e&&t&&e.focus()}const Y={GBFRONT:0,FRONTMATTER:1,GBINTRO:2,SHUFFLEDPASSAGE:3,BACKMATTER:4,GBREAR:5,GBREARCOVER:6};function we(e,t=-1,n=-1){-1!=e&&(e={passageIndex:e,passageName:D[e],passageType:t,displayNumber:n,showTitle:!0,showHeader:!0,showFooter:!0},P.push(e))}var Ce=document.getElementById("currentPage");function showPage(n,l=!1){et=Ze.PAGE,y.hidden&&!l&&goTab("page"),n=Number(n);l=F;if(n>=P.length||n<0)q("Tried to show a page that could not be found");else{Rt=0<(F=n),Ht=F<P.length-1,_t.hidden=!Rt,At.hidden=!Ht;var a=P[n];let e="",t=(-1<ee&&ee<U.length&&a.showHeader&&(e+=`<div class=passage>${qe(ee,n)}</div>`),"");a.showTitle&&(a.passageType!=Y.FRONTMATTER&&a.passageType!=Y.BACKMATTER||(t=a.passageName),0<=a.displayNumber&&(t=a.displayNumber),e+=`<div class=passageTitle><h3>${t}</h3></div>`),e+=`<div class=passage>${qe(a.passageIndex,n)}</div>`,-1<te&&te<U.length&&a.showFooter&&(e+=`<div class=passage>${qe(te,n)}</div>`),Ce.innerHTML=e,lt(!0,!0),vt(v.TURNTO,n,l),Vt&&g==h.length-1&&(a={stepIndex:g,pageIndex:n,sesh:Wt},history.pushState(a,"","?page="+(n+1))),y.scrollTop=0,Yt(),$&&closePeek()}}function previousPage(){showPage(F-1)}function nextPage(){showPage(F+1)}var X=[];function Le(e){let t=0,n=!0,l="",a="";for(;t<e.length;){var i=e.substr(t,1);t==e.length-1||"|"==i&&t<e.length-1&&"|"==e.substr(t+1,1)?((n=!n)&&""!=a.trim()&&(addSwap(l.replace(/\s+/g,""),a.trim()),l="",a=""),t+=2):(n?l+=i:a+=i,t++)}}function addSwap(t,n){if(t.length<2)q("Cannot add text swap of '"+t+"' because it is less than two characters long.");else{for(let e=0;e<X.length;e++)if(t==X[e][0])return void(X[e][1]=n);X.push([t,n])}}var Me="atnoformat,!--,a,abbr,address,area,article,aside,audio,b,bdi,bdo,blockquote,br,button,canvas,caption,cite,code,col,colgroup,data,datalist,dd,del,details,dfn,div,dl,dt,em,embed,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hr,i,iframe,img,input,ins,kbd,label,legend,li,link,map,mark,meta,meter,nav,object,ol,optgroup,option,output,p,param,picture,pre,progress,q,rp,rt,ruby,s,samp,script,section,select,small,source,span,strong,style,sub,summary,sup,svg,table,tbody,td,textarea,tfoot,th,thead,time,tr,track,u,ul,var,video,wbr".split(","),t=!1,c=[],u="",Se=!1,n=0;function toggleSearchUnvisited(){null!=document.getElementById("viewUnvisited")&&(Se=document.getElementById("viewUnvisited").checked)}function beginPageSearch(){""==(u=document.getElementById("pagesearchinput").value.toLowerCase())?t=!1:(document.getElementById("pageSearchResults").innerHTML="",t=!(n=0),c=[],Ue())}var Oe=!0;function Re(){n<P.length-1&&""!=u&&(t=!0,setTimeout(Ue,10),Oe=!0)}function He(){t&&!Oe&&(t=!1)}function Ge(e){return`"peek('${re(e)}','searchMenu')"`}function Pe(e,t,n){let l=1;var a=Fe(e);a||(l=.6);let i=P[e].displayNumber,s=(-1==i&&(i=P[e].passageName),U[P[e].passageIndex].textContent);s=s.slice(0,t)+"<mark>"+s.slice(t,t+n)+"</mark>"+s.slice(t+n);n=Math.max(0,t-100),t=Math.min(s.length,t+100);let r=!1;return t<s.length&&(r=!0),s=s.slice(n,t),0<n&&(s="..."+s.trim()),r&&(s+="..."),Se||a||(s="Unvisited Page..."),`<button style='width:100%;opacity:${l};' onclick=${Ge(P[e].passageName)}>
<span class='searchPageNum'>Page ${e+1}</span>
<div class='searchTitle'>${i}</div><div class='searchSample'>${s}</div></button>`}function Fe(t){for(let e=0;e<h.length;e++)if(h[e].type==v.TURNTO&&h[e].newVal==t)return!0;return!1}function Ue(){var e;t&&(Oe=!1,e="",We[P[n].passageIndex]||qe(P[n].passageIndex,n,!0),(e=U[P[n].passageIndex].textContent.toLowerCase()).includes(u)&&(c.push([n,e.indexOf(u),u.length]),document.getElementById("pageSearchResults").innerHTML+=Pe(n,e.indexOf(u),u.length)),(e=document.getElementById("searchprogress")).value=n+1,e.setAttribute("max",P.length),e.hidden=!1,++n>P.length-1&&(t=!1,e.hidden=!0,0==c.length)&&(document.getElementById("pageSearchResults").innerHTML="No matches found."),t)&&setTimeout(Ue,1)}function De(n){if(n.toLowerCase().includes("<table")&&n.toLowerCase().includes("</table")){var l=n.match(/<td(.*?)<\/td/g);let e=0;var a,i=[];let t=!1;for(;!t;)e=n.toLowerCase().indexOf("<table",e),a=n.toLowerCase().indexOf("</table",e),e<0||a<0?t=!0:(i.push([e,a]),e=a);for(let e=i.length-1;0<=e;e--){var s=n.substring(i[e][0],i[e][1]).replaceAll("AT_NEWLINE_HERE","");n=n.slice(0,i[e][0])+s+n.slice(i[e][1])}var r=n.match(/<td(.*?)<\/td/g);if(l)for(let e=0;e<l.length;e++)n=n.replace(r[e],l[e])}return n}function Ve(e,t,n){return Math.max(e,Math.min(t,n))}var We=[],Ke=[];function qe(t,n,e=!1){if(We.length<U.length)for(let e=0;e<U.length;e++)We.push(!1),Ke.push(null);if(We[t]){for(let e=0;e<Ke[t].length;e++)j.push([Ke[t][e],et]);return U[t].innerHTML}Qe=[];let l=U[t].innerHTML,a=(l=(l=(l=ct(l=(l=l.replace(/\n/g,"AT_NEWLINE_HERE")).replace(/``/g,"AT_BACKTICK_HERE"),l.match(/`(.*?)`/g),"atnoformat",1)).replace(/&lt;/g,"<")).replace(/&gt;/g,">"),!1),i=0;for(;0<=i;)if(-1!=(i=l.indexOf("<",i))){let e=!1,t="";var s=l.indexOf(" ",i)-i,r=l.indexOf(">",i)-i,d=l.indexOf("/",i)-i;let n=99999;if(0<=s&&(n=Math.min(n,s)),0<=r&&(n=Math.min(n,r)),1==(n=0<=d?Math.min(n,d):n)&&12<l.length-i&&"/atnoformat>"==l.substr(i+1,12)&&(a=!1),n<2){if(!a){i++;continue}}else 2<=n&&(t=l.substr(i+1,n-1)),Me.includes(t)||(e=!0);(e||a)&&(l=l.slice(0,i)+"&lt;"+l.slice(i+1)),"atnoformat"==t&&(a=!0),i++}l=De(l);var o=oe.parseFromString(l,"text/html").documentElement.getElementsByTagName("BODY")[0];Je(o,n),l=o.innerHTML;for(let e=0;e<f.length;e++)l=(l=l.replaceAll(f[e].replaceStart,"<"+f[e].tag+">")).replaceAll(f[e].replaceEnd,"</"+f[e].tag+">");var c=l.match(/AT_CSVAL_SPAN\(.*?\)/g);if(c)for(let e=0;e<c.length;e++){var u=l.indexOf(c[e]),h=c[e].substr(c[e].indexOf("(")+1).replace(/\)/g,""),h=p[m(h)],h=`<span displayid='csvaldisplay_0_${h.name}'>${h.val[0]}</span>`;l=l.slice(0,u)+h+l.slice(u+c[e].length)}l=(l=l.replaceAll("AT_NEWLINE_HERE","\n")).replace(/AT_LINEBREAK_HERE/g,"<BR>"),a=!1;var g=l.split(/<atnoformat>|<\/atnoformat>/);l="";for(let e=0;e<g.length;e++)a||(g[e]=ze(g[e],n,/\[\[(.*?)\]\]/g),g[e]=ze(g[e],n,/\[\@(.*?)\@\]/g)),a=!a,l+=g[e];if(l=(l=(l=l.replace(/<atnoformat>/g,"")).replace(/<\/atnoformat>/g,"")).replace(/AT_BACKTICK_HERE/g,"`"),t!=te&&t!=ee&&(We[t]=!0,Ke[t]=Qe,U[t].innerHTML=l),!e)for(let e=0;e<Qe.length;e++)j.push([Qe[e],et]);return l}function ze(r,e,t){var d=r.match(t);if(d)for(let s=0;s<d.length;s++){var o=d[s].replaceAll("&amp;","&"),c=r.indexOf(d[s]),c="-peek"==r.substr(c+d[s].length,5);let n=o,l=o,t=-999;l=re(l=-1!=o.indexOf("-&gt;")?(n=o.substr(2,o.indexOf("-&gt;")-2),o.substr(o.indexOf("-&gt;")+5,o.length-2-(o.indexOf("-&gt;")+5))):-1!=o.indexOf("|")?(n=o.substr(2,o.indexOf("|")-2),o.substr(o.indexOf("|")+1,o.length-2-(o.indexOf("|")+1))):-1!=o.indexOf("&lt;-")?(n=o.substr(o.indexOf("&lt;-")+5,o.length-2-(o.indexOf("&lt;-")+5)),o.substr(2,o.indexOf("&lt;-")-2)):(n=o.substr(2,o.length-4),o.substr(2,o.length-4)));for(let e=0;e<P.length;e++)P[e].passageName==l&&(t=e);let a=l,i=(-999!=t&&P[t].passageType==Y.SHUFFLEDPASSAGE&&(a=P[t].displayNumber),t);if(-999==t)for(let e=0;e<U.length;e++)D[e]==l&&(i='"'+l+'"');if(-999!=i){let e=`<button class='passageLink' onclick='showPage(${i})'>`;o="</button>";let t=`<i>${n}</i> (${e}turn to <b>${a}</b>${o})`;"#"==n&&(t=e+a+o),"turnto"==n&&(t=e+"turn to <b>"+a+"</b>"+o),"Turnto"==n&&(t=e+"Turn to <b>"+a+"</b>"+o),c&&(d[s]+="-peek",e=`<button class='passageLink' onclick='peek(${i})'>`,t=e+n+o),"number"!=typeof i&&(e=`<button class='passageLink' onclick='peek(${i})'>`,t=e+n+o),0<n.length&&'"'==n[0]&&'"'==n[n.length-1]&&(""==(n=n.substr(1,n.length-2))&&(n=l),t=e+n+o),r=r.replace(d[s],t)}}return r}let Ye=["TD","DIV"],Xe=["TABLE","TR","TBODY"],je=[/\$\$page\_.*?\$\$/g,/\$\$passage\_.*?\$\$/g,/\$\$csval\_.*?\$\$/g],f=[];function Je(e,a){var i=e.childNodes;for(let e=0;e<f.length;e++)f[e].childIndex=-1;for(let l=0;l<i.length;l++)if(l,i[l].nodeType==Node.TEXT_NODE){for(let e=0;e<X.length;e++)i[l].textContent.includes(X[e][0])&&(i[l].textContent=i[l].textContent.replaceAll(X[e][0],X[e][1]));i[l].textContent=i[l].textContent.replaceAll("AT_NEWLINE_HERE","\n"),Ye.includes(e.tagName)&&(0==l&&(i[l].textContent=i[l].textContent.trimStart()),l==i.length-1)&&(i[l].textContent=i[l].textContent.trimEnd()),i[l].textContent=i[l].textContent.replace(/\n/g,"AT_LINEBREAK_HERE");for(let n=0;n<je.length;n++){var s=i[l].textContent.match(je[n]);if(s&&0<s.length)for(let e=0;e<s.length;e++){var r,d=s[e].substr(s[e].indexOf("_")+1).replace(/\$/g,""),o=i[l].textContent.indexOf(s[e]);let t="?";if(0==n){for(let e=0;e<P.length;e++)P[e].passageName==d&&(t=e+1);"this"==d&&(t=a+1),"total"==d&&(t=P.length)}if(1==n){for(let e=0;e<P.length;e++)P[e].passageName==d&&(t=0<P[e].displayNumber?P[e].displayNumber:P[e].passageName);"this"==d&&(t=P[a].displayNumber<1?P[a].passageName:P[a].displayNumber),"total"==d&&(t=Z)}2==n&&-1!=(r=m(d))&&(t="AT_CSVAL_SPAN("+p[r].name+")"),i[l].textContent=i[l].textContent.slice(0,o)+t+i[l].textContent.slice(o+s[e].length)}}for(let n=0;n<i[l].textContent.length;n++)for(let t=0;t<f.length;t++){let e=!1;if(e=i[l].textContent.length-n>=f[t].code.length&&i[l].textContent.substr(n,f[t].code.length)==f[t].code?!0:e)if(-1==f[t].childIndex)f[t].childIndex=l,f[t].stringIndex=n,n+=f[t].code.length-1;else{if(i[f[t].childIndex].textContent=i[f[t].childIndex].textContent.substr(0,f[t].stringIndex)+f[t].replaceStart+i[f[t].childIndex].textContent.substr(f[t].stringIndex+f[t].code.length),f[t].childIndex==l)n+=f[t].replaceStart.length-f[t].code.length;else for(let e=0;e<f.length;e++)f[e].childIndex==f[t].childIndex&&f[e].stringIndex>f[t].stringIndex&&(f[e].stringIndex+=f[t].replaceStart.length-f[t].code.length);i[l].textContent=i[l].textContent.substr(0,n)+f[t].replaceEnd+i[l].textContent.substr(n+f[t].code.length),n+=f[t].replaceEnd.length,f[t].childIndex=-1,f[t].stringIndex=-1}}}for(let e=0;e<i.length;e++)i[e].nodeType==Node.ELEMENT_NODE&&"ATNOFORMAT"!=i[e].tagName&&"STYLE"!=i[e].tagName&&"SCRIPT"!=i[e].tagName&&Je(i[e],a),"SCRIPT"==i[e].tagName&&(i[e].innerHTML=i[e].innerHTML.replace(/AT_NEWLINE_HERE/g,"\n"),Qe.push(i[e])),"ATNOFORMAT"==i[e].tagName&&(i[e].innerHTML=i[e].innerHTML.replace(/\n/g,"AT_LINEBREAK_HERE"),i[e].innerHTML=i[e].innerHTML.replace(/AT_NEWLINE_HERE/g,"AT_LINEBREAK_HERE"))}f.push({code:"''",tag:"b",childIndex:-1,stringIndex:-1,replaceStart:"AT_B_TAGOPEN",replaceEnd:"AT_B_TAGCLOSE"}),f.push({code:"//",tag:"i",childIndex:-1,stringIndex:-1,replaceStart:"AT_I_TAGOPEN",replaceEnd:"AT_I_TAGCLOSE"}),f.push({code:"^^",tag:"sup",childIndex:-1,stringIndex:-1,replaceStart:"AT_SUP_TAGOPEN",replaceEnd:"AT_SUP_TAGCLOSE"}),f.push({code:"~~",tag:"s",childIndex:-1,stringIndex:-1,replaceStart:"AT_S_TAGOPEN",replaceEnd:"AT_S_TAGCLOSE"}),f.push({code:"__",tag:"u",childIndex:-1,stringIndex:-1,replaceStart:"AT_U_TAGOPEN",replaceEnd:"AT_U_TAGCLOSE"}),f.push({code:"**",tag:"strong",childIndex:-1,stringIndex:-1,replaceStart:"AT_STRONG_TAGOPEN",replaceEnd:"AT_STRONG_TAGCLOSE"}),f.push({code:"*",tag:"em",childIndex:-1,stringIndex:-1,replaceStart:"AT_EM_TAGOPEN",replaceEnd:"AT_EM_TAGCLOSE"});var Qe=[];const Ze={STORY:0,SHEET:1,PAGE:2,PEEK:3};var et=0,j=[],tt=[document.getElementById("StoryScriptsNode"),document.getElementById("CharacterSheetScriptsNode"),document.getElementById("PassageScriptsNode"),document.getElementById("PeekScriptsNode")];function nt(e){for(;e.firstChild;)e.removeChild(e.lastChild)}function lt(e=!1,t=!1){if(se&&(e&&nt(tt[2]),t&&nt(tt[3]),0!=j.length)){for(let t=0;t<4;t++)for(let e=0;e<j.length;e++){var n,l;j[e][1]==t&&(n=document.createElement("script"),l=document.createTextNode(j[e][0].innerHTML),n.appendChild(l),tt[Math.min(t,tt.length-1)].appendChild(n).innerHTML)}j=[]}}var at="00011001011101111011000000010111000110110001011010010010110110001000101101000010010110010011101111110110101100010111010000100011001111110110010000101011011100010001011100011111101101101",it=0,st=0,rt=0;function dt(){return it++,it%=at.length,.5<Number(at[it])?st+=.17:st+=.29,rt=(rt+st)%1}function ot(e,l){var a=[];let i=0;for(;i<e.length;){let t=-99,n=-1;for(let e=0;e<l.length;e++)l[e]>=t&&(t=l[e],n=e);-99==t?a.push(e[n]):a.unshift(e[n]),i++,l[n]=-99999}return a}function ct(t,n,l,a=2){if(n)for(let e=0;e<n.length;e++){var i=t.indexOf(n[e]),s=`<${l}>${n[e].substr(a,n[e].length-2*a)}</${l}>`;t=t.slice(0,i+a-1)+s+t.slice(i+n[e].length-a+1)}return t}var h=[],g=-1,ut=!1;const v={TURNTO:0,CHANGEVALUE:1,GROUPBEGIN:2,GROUPEND:3};var ht=!1;function clearGameHistory(){Wt=Date.now(),undoToAction(0),s("saveGameExists");let e=!1,t=0;for(;!e;)null==r("h_"+t)?e=!0:(s("h_"+t),s("hn_"+t),s("hp_"+t),s("ht_"+t),s("hi_"+t),t++);for(let e=0;e<h.length;e++)h[e].display&&h[e].display.remove();for(let t=0;t<p.length;t++)if(p[t].nohistory)for(let e=0;e<p[t].val.length;e++)csSet(p[t].name,p[t].initialVals[e],e);h=[],g=-1,showPage(0)}function gt(){if(null!=r("saveGameExists")){for(let e=0;e<h.length;e++)h[e].display&&h[e].display.remove();h=[];let e=!(g=-1),t=0;for(;!e;){var n,l,a,i,s;null==r("h_"+t)?e=!0:(n=+r("h_"+t),l=r("hn_"+t),a=r("hp_"+t),i=r("ht_"+t),s=r("hi_"+t),n==v.GROUPBEGIN&&(mt=!0,ft=l),n==v.GROUPEND&&(mt=!1),vt(n,l,a,i,s),t++)}g=0,undoToAction(h.length-1)}ht=!0}function pt(){if(ht){i("saveGameExists","y");for(let e=0;e<h.length;e++)i("h_"+e,h[e].type),i("hn_"+e,h[e].newVal),i("hp_"+e,h[e].oldVal),i("ht_"+e,h[e].target),i("hi_"+e,h[e].valueIndex)}}var mt=!1,ft="";function beginActionGroup(e){mt&&EndActionGroup(),mt=!0,ft=e,vt(v.GROUPBEGIN,e)}function endActionGroup(){mt=!1,vt(v.GROUPEND,ft)}function vt(e,t,n=-1,l=-1,a=0){if(!ut){if(g<h.length-1){for(let e=g+1;e<h.length;e++)h[e].display&&h[e].display.remove(),s("h_"+e),s("hn_"+e),s("hp_"+e),s("ht_"+e),s("hi_"+e);h.splice(g+1)}if(-1!=g){var i=h[g];if(i.type==v.CHANGEVALUE&&i.target==l&&i.valueIndex==a)return i.newVal=t,h[g].display.innerHTML=bt(i),void pt()}i={type:e,newVal:t,oldVal:n,target:l,valueIndex:a,display:!1},e=(h.push(i),g=h.length-1,document.createElement("div"));(i.display=e).className="historyElement",e.setAttribute("onclick","undoToAction("+g+")"),e.innerHTML=bt(i),mt||(yt.appendChild(e),Et(),It()),pt()}}var yt=document.getElementById("historyList");function bt(t){let n="Action";if(t.type==v.TURNTO){let e="";var l=P[t.newVal];l.passageType!=Y.FRONTMATTER&&l.passageType!=Y.BACKMATTER||(e=l.passageName),""==(e=0<=l.displayNumber?l.displayNumber:e)&&(e="page "+(Number(t.newVal)+1)),n="Turned to "+e}if(1==h.length&&(n="Received a Tome"),t.type==v.CHANGEVALUE){l=m(t.target);if(-1==l)return"Error: Couldn't find action target";let e=t.newVal;50<e.length&&(e=e.slice(0,48)+"..."),n=`Changed ${p[l].label} to <i>${e}</i>`,"toggle"==p[l].type&&(e="Off",1==t.newVal&&(e="On"),n=`Toggled ${p[l].label} <i>${e}</i>`),1<p[l].val.length&&(n=`Changed ${p[l].label} (${Number(t.valueIndex)+1}) to <i>${e}</i>`,"toggle"==p[l].type)&&(e="Off",1==t.newVal&&(e="On"),n=`Toggled ${p[l].label} (${Number(t.valueIndex)+1}) <i>${e}</i>`)}return n=t.type==v.GROUPEND?t.newVal:n}function undo(){if(0!=g){let e=g-1;if(h[g].type==v.GROUPEND){for(;h[e].type!=v.GROUPBEGIN;)e--;e--}undoToAction(e)}}function redo(){if(!(g>=h.length-1)){let e=g+1;if(h[e].type==v.GROUPBEGIN)for(;h[e].type!=v.GROUPEND;)e++;undoToAction(e)}}function undoToAction(e){if(g!=e){var t,n,l=F;for(let e=0;e<p.length;e++)p[e].valHasChanged=!1;for(;e<g;)h[g].type==v.TURNTO?F=Number(h[g].oldVal):h[g].type==v.CHANGEVALUE&&-1!=(t=m(h[g].target))&&(p[t].val[h[g].valueIndex]=h[g].oldVal,p[t].valHasChanged=!0),g--;for(;g<e;)h[++g].type==v.TURNTO?F=Number(h[g].newVal):h[g].type==v.CHANGEVALUE&&-1!=(n=m(h[g].target))&&(p[n].val[h[g].valueIndex]=h[g].newVal,p[n].valHasChanged=!0);ut=!0,F!=l&&showPage(F,!0);for(let e=0;e<p.length;e++)p[e].valHasChanged&&ke(p[e]);ut=!1,Et(),It(),pt()}}function Et(){for(let e=0;e<h.length;e++)h[e].display&&(h[e].display.className="historyElement");h[g].display&&(h[g].display.className="historyElementActive",h[g].display.scrollIntoView())}var Tt=document.getElementById("undoButton"),xt=document.getElementById("redoButton");function It(){Tt.disabled=0==g,xt.disabled=g==h.length-1}var y=document.getElementById("pagePanel"),_t=document.getElementById("pageLeftDiv"),At=document.getElementById("pageRightDiv"),b=document.getElementById("leftPanel"),Nt=document.getElementById("leftPanelTabs"),E=document.getElementById("rightPanel"),$t=document.getElementById("rightPanelTabs"),kt=document.getElementById("narrowDisplayTabs"),Bt=document.getElementById("narrowCharaSheetButton"),wt=!1,Ct="none",T=-1,Lt=document.getElementById("historyTab"),Mt=document.getElementById("historyTabButton"),St=document.getElementById("bookmarksTab"),Ot=document.getElementById("bookmarksTabButton");function goPanelLeft(e){"none"==e||e==Ct?(b.hidden=!0,Ct="none",x(),Mt.setAttribute("type","inactive"),Ot.setAttribute("type","inactive")):(Ct=e,b.hidden=!1,x(),"history"==e&&(Lt.hidden=!1,St.hidden=!0,Mt.setAttribute("type","active"),Ot.setAttribute("type","inactive"),Et()),"bookmarks"==e&&(Lt.hidden=!0,St.hidden=!1,Mt.setAttribute("type","inactive"),Ot.setAttribute("type","active")))}function goPanelRight(e){if((e=Number(e))==T||-1==e){E.hidden=!0,T=-1,x();for(let e=0;e<V.length;e++)document.getElementById("atcharsheettab_"+e).setAttribute("type","inactive")}else{T=e,E.hidden=!1;for(let e=0;e<V.length;e++)document.getElementById("atcharsheet_"+e).hidden=T!=e,document.getElementById("atcharsheettab_"+e).setAttribute("type","inactive"),T==e&&document.getElementById("atcharsheettab_"+e).setAttribute("type","active");x()}}function goTab(e){if("history"==e||"bookmarks"==e){if(!b.hidden&&("history"==e&&!Lt.hidden||"bookmarks"==e&&!St.hidden))return void goTab("page");"history"==e?(Lt.hidden=!1,St.hidden=!0):(Lt.hidden=!0,St.hidden=!1),b.hidden=!1,y.hidden=!0,E.hidden=!0,Et()}if("page"==e&&(b.hidden=!0,y.hidden=!1,E.hidden=!0),"sheet"==e){T<0&&(T=0),E.hidden||++T>=V.length&&(T=0),Bt.innerHTML=D[V[T]];for(let e=0;e<V.length;e++)document.getElementById("atcharsheet_"+e).hidden=T!=e,document.getElementById("atcharsheettab_"+e).setAttribute("type","inactive"),T==e&&document.getElementById("atcharsheettab_"+e).setAttribute("type","active");b.hidden=!0,y.hidden=!0,E.hidden=!1}_t.hidden=y.hidden||!Rt,At.hidden=y.hidden||!Ht,x()}var Rt=!1,Ht=!1,J="auto",Gt=[-1,-1],onresize=e=>{setTimeout(Pt,30)};function Pt(){window.outerWidth==Gt[0]&&window.outerHeight==Gt[1]||x()}function x(){if(se){if(Gt=[window.outerWidth,window.outerHeight],0==V.length&&(E.style.display="none",$t.style.display="none",Bt.style.display="none"),"full"==J||1e3<=window.innerWidth&&"auto"==J){kt.style.display="none",kt.hidden=!0,y.hidden=!1;let e=500,t=250;b.hidden&&(t=0),E.hidden&&(e=0),Ft(t,e,0,0),Ut(window.innerWidth-e,0,0,0,!0,!1,E,$t),Ut(0,window.innerWidth-t,0,0,!0,!0,b,Nt)}else kt.style.display="table",kt.hidden=!1,E.hidden||(y.hidden=!0,b.hidden=!0),b.hidden||(y.hidden=!0,E.hidden=!0),y.hidden||(b.hidden=!0,E.hidden=!0),y.hidden&&b.hidden&&E.hidden&&(y.hidden=!1),Ft(0,0,kt.offsetHeight,0),Ut(0,0,kt.offsetHeight,0,!1,!1,E,$t),Ut(0,0,kt.offsetHeight,0,!1,!0,b,Nt);_t.hidden=y.hidden||!Rt,At.hidden=y.hidden||!Ht,wt&&(E.hidden&&(T=-1),b.hidden&&(Ct="none"),i("tabRightCurrent",T),i("tabLeftCurrent",Ct))}}function Ft(e,t,n,l){var a=window.innerWidth-(e+t),l=(y.style.left=e+"px",y.style.right=t+"px",y.style.top=n+"px",y.style.bottom=l+"px",y.style.bottom=`calc(env(safe-area-inset-bottom) + ${l}px)`,y.style.height=`calc(100vh - ${n}px)`,(a-700)/4),n=e+l-25,n=Math.max(n,e+5),a=t+l-25,a=Math.max(a,t+5);_t.style.left=n+"px",At.style.right=a+"px"}function Ut(e,t,n,l,a,i,s,r){var d=window.innerWidth-(e+t);s.style.left=e+"px",s.style.right=t+"px",s.style.top=n+"px",s.style.bottom=l+"px",s.style.width=d+"px",s.style.height=`calc(100vh - ${n}px)`,r.hidden=!a,i?(r.style.left=d-2+"px",yt.style.height=`calc(100vh - ${80+n}px)`):r.style.right=d-2+"px"}var Dt=document.createElement("style"),Vt=(Dt.type="text/css",Dt.innerText=document.getElementsByTagName("adventuretomestyle")[0].innerText,document.head.appendChild(Dt),(Dt=document.createElement("style")).type="text/css",Dt.innerText=document.getElementById("twine-user-stylesheet").innerText,document.head.appendChild(Dt),!0),Wt=Date.now();function Kt(){let n="<div style='width:100%;padding-top:50vh'>You have no saved bookmarks.</div>";if(0<o.length){o.sort(jt),n="";for(let t=0;t<o.length;t++){var l=P[o[t].page];let e=l.displayNumber;-1==e&&(e=l.passageName),n+=`<div style='padding:5px;'>
<button onclick="peek('${re(o[t].name)}')" style="width:100%;">
${e}<span style='float:right;'>
<small><i>Page ${o[t].page+1}</i></small>
</span></button></div>`}}St.innerHTML=n}var qt=document.getElementById("bookmarkButton"),zt=document.getElementById("bookmarkButtonImg");function Yt(){let t=!1;for(let e=0;e<o.length;e++)o[e].page==F&&(t=!0);t?(qt.setAttribute("title","Unbookmark this page."),zt.setAttribute("type","on")):(qt.setAttribute("title","Bookmark this page."),zt.setAttribute("type","off")),-1!=Jt(L)?l.textContent="Remove Bookmark":l.textContent="Bookmark this"}function bookmarkCurrent(){Qt(P[F].passageName,!1,!0)}function bookmarkPeek(e){Qt(P[e].passageName,!1,!0)}function Xt(e){o[e].fixed||(o.splice(e,1),Yt(),Zt(),Kt())}function jt(e,t){return e.fixed&&!t.fixed?-1:!e.fixed&&t.fixed?1:e.page-t.page}function Jt(t){for(let e=0;e<o.length;e++)if(o[e].page==t)return e;return-1}function Qt(t,e=!1,n=!1){let l=-1;for(let e=0;e<P.length;e++)P[e].passageName==t&&(l=e);if(-1!=l){if(n){var a=Jt(l);if(-1!=a)return void Xt(a)}a={page:l,name:t,fixed:e};o.push(a),Yt(),n&&Zt(),Kt()}}function Zt(){let t=0;for(;null!=r("atbkmk_"+t);)s("atbkmk_"+t),t++;for(let e=t=0;e<o.length;e++)o[e].fixed||(i("atbkmk_"+t,o[e].name),t++)}try{de(),document.getElementById("adventureTomeLoading").hidden=!0,document.getElementById("adventureTomeView").hidden=!1,x()}catch(e){document.getElementById("adventureTomeLoading").innerHTML="Initialisation Error:<br><br><small>"+e.message}function en(){let e="atcustomfont"==K?ae:"atdefaultfont"==K?"inherit":K;y.style.fontSize=W+"%",k.style.fontSize=W+"%",y.style.fontFamily=e,k.style.fontFamily=e}function toggleDarkMode(){(d=!d)?(document.getElementById("darkModeButton").innerHTML=_,document.body.classList.toggle("dark-theme"),i("darkmode","y")):(document.getElementById("darkModeButton").innerHTML=A,document.body.classList.contains("dark-theme")&&document.body.classList.remove("dark-theme"),i("darkmode","n"))}window.addEventListener("popstate",t=>{if(t.state.sesh==Wt){let e=g;(e=null!=t.state.stepIndex?Number(t.state.stepIndex):e)!=g&&0<=e&&e<h.length&&(Vt=!1,undoToAction(e),Vt=!0)}});</script></body></html> 